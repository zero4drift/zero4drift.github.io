<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="CSAPP shlab 模拟 linux shell fg bg signal eval trace">
<meta name="viewport" content="width=device-width">
<title>CSAPP-shlab 解题思路记录 | 钉钉是世界上最傻逼的app</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://zero4drift.github.io/posts/csapp-shlab-jie-ti-si-lu-ji-lu/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="zero4drift">
<meta property="og:site_name" content="钉钉是世界上最傻逼的app">
<meta property="og:title" content="CSAPP-shlab 解题思路记录">
<meta property="og:url" content="https://zero4drift.github.io/posts/csapp-shlab-jie-ti-si-lu-ji-lu/">
<meta property="og:description" content="CSAPP shlab 模拟 linux shell fg bg signal eval trace">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-03-10T18:07:32+08:00">
<meta property="article:tag" content="c">
<meta property="article:tag" content="csapp">
<meta property="article:tag" content="lab">
</head>
<body>
    

    <header id="header" class="navbar"><div class="container">
            
    <div class="brand">

        <div class="brand-text">
            <a href="https://zero4drift.github.io/" title="钉钉是世界上最傻逼的app" rel="home">
                钉钉是世界上最傻逼的app
            </a>
        </div>

        <a id="btn-toggle-nav" class="navbar-toggle">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
    </div>

            
    <nav class="navbar-collapse collapse"><ul class="nav">
<li><a href="../../archive.html">Archive</a></li>
                <li><a href="https://github.com/zero4drift">Github</a></li>
                <li><a href="../../categories/">Tags</a></li>
                <li><a href="../../rss.xml">RSS feed</a></li>
    
    
    </ul></nav>
</div>
    </header><div class="header-padding"> </div>

    
    <div class="post-header">
        <div class="container">
            <div class="title">
                CSAPP-shlab 解题思路记录
            </div>
        </div>
    </div>

    <div class="post-meta">
      <div class="container">
	<div class="meta clearfix">
	  <div class="authordate">
	    <time class="timeago" datetime="2018-03-10T18:07:32+08:00">2018/03/10</time>
</div>
	  <div class="post-tags">
	    <div class="tag">
	      <a href="../../categories/c/" rel="tag">c</a>
	    </div>
	    <div class="tag">
	      <a href="../../categories/csapp/" rel="tag">csapp</a>
	    </div>
	    <div class="tag">
	      <a href="../../categories/lab/" rel="tag">lab</a>
	    </div>
	  </div>
	</div>
      </div>
    </div>
    
    
    <div id="post-main" class="main">
        <div class="container">
        <div id="outline-container-orgd1efae3" class="outline-2">
<h2 id="orgd1efae3">写在前面</h2>
<div class="outline-text-2" id="text-orgd1efae3">
<p>
我宁愿去处理汇编代码！这次的 lab 太繁杂太发散；汇编虽然难，起码有的放矢，一码是一码。
</p>
</div>

<div id="outline-container-org2d83509" class="outline-3">
<h3 id="org2d83509">阅读官方指导文档</h3>
<div class="outline-text-3" id="text-org2d83509">
<p>
这次必须仔细阅读文档，否则必然踩坑，本篇文章十有八九也看不懂了：<a href="http://csapp.cs.cmu.edu/3e/shlab-release.html">文档的链接在这里</a>。
</p>
</div>

<div id="outline-container-orgac2f19f" class="outline-4">
<h4 id="orgac2f19f">要求</h4>
<div class="outline-text-4" id="text-orgac2f19f">
<ol class="org-ol">
<li>提供了一个模板可执行文件 <code>./tshref</code>, 最后完成的 <code>./tsh</code> 在运行时必须和模板表现一致；</li>
<li>提供了16个 trace 文件，lab 提交之后是比较 <code>./tsh</code> 在这16个 trace 文件的输入后
的表现是否与同样条件下的 <code>./tshref</code> 一致来评分的；</li>
<li>需要完成 <code>./tsh.c</code> 中的7个函数，分别是：
<ol class="org-ol">
<li><a href="#org2e6e4bf">eval</a></li>
<li><a href="#orgaa4178d">builtin_cmd</a></li>
<li><a href="#org324eeff">do_bgfg</a></li>
<li><a href="#org19c7b4f">waitfg</a></li>
<li><a href="#orgfc92614">sigchld_handler</a></li>
<li><a href="#org38cb018">sigint_handler</a></li>
<li><a href="#org464963f">sigstp_handler</a></li>
</ol>
</li>
</ol>
<!-- TEASER_END -->
</div>
</div>

<div id="outline-container-org3e21ecb" class="outline-4">
<h4 id="org3e21ecb">提示</h4>
<div class="outline-text-4" id="text-org3e21ecb">
<p>
lab 文档在最后给出了几条提示，有几条特别重要：
</p>

<ol class="org-ol">
<li>第三条：waitpid, kill, fork, execve, setpgid 和 sigprocmask 非常有用，在
waitpid 中使用 WUNTRACED 和 WNOHANG 参数选项讲极大的减少工作量（前提是，仔细
阅读 waitpid 的文档，了解其常规用法）；</li>
<li>第四条：在实现 sigint_handler 和 sigstp_handler 的过程中，在调用 kill 函数时
第一个参数使用 <code>-pid</code> 而不是 <code>pid</code>, 这样就可以把 SIGINT 和 SIGSTP 信号发送到
整个前台进程组；</li>
<li>第五条：在待实现的 waitfg 函数中使用一个内部是 sleep 函数调用的 while 循环，
搭配着在 sigchld_handler 中只调用一次 waitpid 函数；</li>
<li>第六条：在待实现的 eval 函数中，在调用 fork 函数派生子进程之前使用
sigprocmask 来屏蔽 SIGCHLD 信号，在 eval 中调用 addjob 函数之后再调用一次
sigprocmask 来解除屏蔽，被调用的子进程在调用 execve 之前也必须解除屏蔽；</li>
<li>第八条：eval 中派生的子进程必须调用 setpid(0, 0) 来确保自己的进程组ID和自己的PID一样，
确保自己的进程组ID和 运行时的 <code>./tsh</code> 不一样；因为 <code>./tsh</code> 是在 Unix shell 中
运行的，它其实就是在前台进程组中运行的，如果 <code>./tsh</code> 派生出子进程，默认这个子
进程就将是前台进程组中的一员；如果在控制台中键入 ctrl-c, SIGINT 信号将会被送
到前台进程组中的所有成员；</li>
</ol>
<p>
可以这样理解，这里每一条提示都不只是建议，而是可以大大减少工作量的最优解。
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org06e9edc" class="outline-2">
<h2 id="org06e9edc">代码工作</h2>
<div class="outline-text-2" id="text-org06e9edc">
<p>
鉴于代码中已经写了大量注释（以及实践过程中踩坑的记录以博一笑），这里就把代码搬运过来就可以了。
</p>
</div>

<div id="outline-container-org2e6e4bf" class="outline-3">
<h3 id="org2e6e4bf">eval</h3>
<div class="outline-text-3" id="text-org2e6e4bf">
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">eval</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmdline</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">bg_or_not</span><span class="p">,</span> <span class="n">builtin_or_not</span><span class="p">,</span> <span class="n">is_available_cmd</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="n">MAXARGS</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">first_cmd</span><span class="p">;</span>
  <span class="kt">sigset_t</span> <span class="n">blockset</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg</span> <span class="o">=</span> <span class="s">"%s: Command not found</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="cm">/* 使用一个字符串数组来存储所有可以接受的命令 */</span>
  <span class="cm">/* 偷懒使用这样的硬编码方式，肯定有更好的在路径查询函数，比如查询 '/bin/echo' 是否存在 */</span>
  <span class="cm">/* 更新：这个函数就是C库函数 access, 这个硬编码套路留着以博一笑 :) */</span>
  <span class="cm">/* const char *available_cmds[5]={"./myint", "./myspin", "./mysplit", "./mystop", "/bin/echo"}; */</span>
  <span class="cm">/* 创建空的信号集合 */</span>
  <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blockset</span><span class="p">);</span>
  <span class="cm">/* 添加指定信号到集合中 */</span>
  <span class="n">sigaddset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blockset</span><span class="p">,</span> <span class="n">SIGCHLD</span><span class="p">);</span>
  <span class="n">bg_or_not</span> <span class="o">=</span> <span class="n">parseline</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
  <span class="n">first_cmd</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">builtin_or_not</span> <span class="o">=</span> <span class="n">builtin_cmd</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">builtin_or_not</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">is_available_cmd</span> <span class="o">=</span> <span class="n">access</span><span class="p">(</span><span class="n">first_cmd</span><span class="p">,</span> <span class="mo">00</span><span class="p">);</span>
      <span class="cm">/* 硬编码套路 */</span>
      <span class="cm">/* for(i=0;i&lt;5;i++) */</span>
      <span class="cm">/* 	{ */</span>
      <span class="cm">/* 	  if(!strcmp(first_cmd, available_cmds[i])) */</span>
      <span class="cm">/* 	    { */</span>
      <span class="cm">/* 	      is_available_cmd = 1; */</span>
      <span class="cm">/* 	      break; */</span>
      <span class="cm">/* 	    } */</span>
      <span class="cm">/* } */</span>
      <span class="k">if</span><span class="p">(</span><span class="n">is_available_cmd</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="n">err_msg</span><span class="p">,</span> <span class="n">first_cmd</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="cm">/* 阻塞对应信号，最后一个参数是 NULL 是因为不需要保存之前的集合为备份 */</span>
      <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_BLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blockset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
      <span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">bg_or_not</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">state</span> <span class="o">=</span> <span class="n">BG</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="p">{</span>
	      <span class="n">state</span> <span class="o">=</span> <span class="n">FG</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="n">addjob</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">);</span>
	  <span class="cm">/* 在执行完 addjob 之后需要在父进程中取消阻塞 */</span>
	  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_UNBLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blockset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">state</span><span class="o">==</span><span class="n">FG</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* 如果是 foreground job, 需要等待其完成 */</span>
	      <span class="n">waitfg</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
	    <span class="p">}</span>
	  <span class="k">else</span>
	    <span class="p">{</span>
	      <span class="n">printf</span><span class="p">(</span><span class="s">"[%d] (%d) %s"</span><span class="p">,</span> <span class="n">maxjid</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span> <span class="n">pid</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* lab pdf 中的提示，后台子进程需要更改自己的组号 */</span>
	  <span class="cm">/* 因为 ./tsh 执行时其实就是一个 foreground process */</span>
	  <span class="cm">/* 任何本程序派生的子进程默认都在 foreground process group 里 */</span>
	  <span class="n">setpgid</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="cm">/* 子进程继承了父进程的阻塞状态，必须在 execve 前取消阻塞 */</span>
	  <span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_UNBLOCK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blockset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	  <span class="n">execve</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="n">environ</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-orgaa4178d" class="outline-3">
<h3 id="orgaa4178d">builtin_cmd</h3>
<div class="outline-text-3" id="text-orgaa4178d">
<div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">builtin_cmd</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">first_cmd</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">first_cmd</span><span class="p">,</span> <span class="s">"quit"</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">first_cmd</span><span class="p">,</span> <span class="s">"jobs"</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">listjobs</span><span class="p">(</span><span class="n">jobs</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">first_cmd</span><span class="p">,</span> <span class="s">"bg"</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">first_cmd</span><span class="p">,</span> <span class="s">"fg"</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">do_bgfg</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>     <span class="cm">/* not a builtin command */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-org324eeff" class="outline-3">
<h3 id="org324eeff">do_bgfg</h3>
<div class="outline-text-3" id="text-org324eeff">
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">do_bgfg</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">jid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pid</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_number</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">job_t</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">first_cmd</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">second_cmd</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">e</span><span class="p">;</span>
  <span class="cm">/* 几个格式化字符串常量提示错误 */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg1</span> <span class="o">=</span> <span class="s">"%s command requires PID or %%jobid argument</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg2</span> <span class="o">=</span> <span class="s">"%s argument must be a PID or %%jobid</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg3</span> <span class="o">=</span> <span class="s">"%s: No such job</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">err_msg4</span> <span class="o">=</span> <span class="s">"(%d): No such process</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">second_cmd</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* 如果 bg fg 没有带第二个参数 */</span>
      <span class="n">printf</span><span class="p">(</span><span class="n">err_msg1</span><span class="p">,</span> <span class="n">first_cmd</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">second_cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="sc">'%'</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* 如果第二个参数以 '%' 开头，就是一个 jobid */</span>
      <span class="n">str_number</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">second_cmd</span><span class="p">,</span> <span class="s">"%"</span><span class="p">);</span>
      <span class="cm">/* 验证 '%' 后面的字符串是不是一个数字字符串 */</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">strlen</span><span class="p">(</span><span class="n">str_number</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">e</span> <span class="o">=</span> <span class="n">str_number</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">==</span><span class="sc">'\0'</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">&lt;</span><span class="sc">'0'</span> <span class="o">||</span> <span class="n">e</span><span class="o">&gt;</span><span class="sc">'9'</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* 如果有数字字符以外的东西，报错 */</span>
	      <span class="n">printf</span><span class="p">(</span><span class="n">err_msg2</span><span class="p">,</span> <span class="n">first_cmd</span><span class="p">);</span>
	      <span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="cm">/* 数字字符串转换为数字 */</span>
      <span class="n">jid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">str_number</span><span class="p">);</span>
      <span class="n">job</span> <span class="o">=</span> <span class="n">getjobjid</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">jid</span><span class="p">);</span>
      <span class="cm">/* 如果 job 不存在的话，报错 */</span>
      <span class="cm">/* 其实这里也可以比较 jid 和 maxjid 执行获得的 jobs 中最大的 jid */</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">job</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="n">err_msg3</span><span class="p">,</span> <span class="n">second_cmd</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="k">else</span>
	<span class="p">{</span>
	  <span class="cm">/* 这里需要拿到 pid, 后面会用 */</span>
	  <span class="n">pid</span> <span class="o">=</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="cm">/* 同样的，对于不是以 '%' 开头的字符串，检查其是否是数字字符串 */</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">strlen</span><span class="p">(</span><span class="n">second_cmd</span><span class="p">);</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="n">e</span> <span class="o">=</span> <span class="n">second_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">==</span><span class="sc">'\0'</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">&lt;</span><span class="sc">'0'</span> <span class="o">||</span> <span class="n">e</span><span class="o">&gt;</span><span class="sc">'9'</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">printf</span><span class="p">(</span><span class="n">err_msg2</span><span class="p">,</span> <span class="n">first_cmd</span><span class="p">);</span>
	      <span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
      <span class="n">pid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">second_cmd</span><span class="p">);</span>
      <span class="n">job</span> <span class="o">=</span> <span class="n">getjobpid</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">job</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="cm">/* 如果 job 不存在，报错 */</span>
	  <span class="n">printf</span><span class="p">(</span><span class="n">err_msg4</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
  <span class="cm">/* 这也在 shlab pdf 中重点讲过 */</span>
  <span class="cm">/* The bg(fg) &lt;job&gt; command restarts &lt;job&gt; by sending it a SIGCONT signal */</span>
  <span class="cm">/* and then runs it in the background. */</span>
  <span class="cm">/* When you implement your signal handlers, be sure to send SIGINT and SIGSTP signals to the entire foreground process group */</span>
  <span class="cm">/* using "-pid" instead of "pid" in the argument to the kill function. */</span>
  <span class="n">kill</span><span class="p">(</span><span class="o">-</span><span class="n">pid</span><span class="p">,</span> <span class="n">SIGCONT</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">first_cmd</span><span class="p">,</span> <span class="s">"bg"</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">job</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BG</span><span class="p">;</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"[%d] (%d) %s"</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">job</span><span class="o">-&gt;</span><span class="n">cmdline</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">job</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FG</span><span class="p">;</span>
      <span class="cm">/* 当 job state 是 FG 的时候，要等待其完成 */</span>
      <span class="n">waitfg</span><span class="p">(</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-org19c7b4f" class="outline-3">
<h3 id="org19c7b4f">waitfg</h3>
<div class="outline-text-3" id="text-org19c7b4f">
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">waitfg</span><span class="p">(</span><span class="kt">pid_t</span> <span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* 我原来的做法是这样的，这当然可以解决问题，毕竟 forground job 结束之后会被 reap */</span>
  <span class="cm">/* 见 sigchld_handler, 最后执行的 deletejob 只是清理 job 的内容 */</span>
  <span class="cm">/* 指向这个 job 的指针仍然存在（内存空间没有被回收） */</span>
  <span class="cm">/* struct job_t *job = getjobpid(jobs, pid); */</span>
  <span class="cm">/* if(job) */</span>
  <span class="cm">/*   { */</span>
  <span class="cm">/*     while(job-&gt;state==FG) */</span>
  <span class="cm">/* 	{ */</span>
  <span class="cm">/* 	  sleep(1); */</span>
  <span class="cm">/* 	} */</span>
  <span class="cm">/*   } */</span>
  <span class="k">while</span><span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">fgpid</span><span class="p">(</span><span class="n">jobs</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-orgfc92614" class="outline-3">
<h3 id="orgfc92614">sigchld_handler</h3>
<div class="outline-text-3" id="text-orgfc92614">
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">sigchld_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="cm">/* 这个就要需要详细了解 waitpid 这个函数了，见 man waitpid */</span>
  <span class="cm">/* :( 其实看了文档之后还是有点找不到北，按照指导说明拼凑下面的代码，改了多次才验证成功 */</span>
  <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">job_t</span> <span class="o">*</span><span class="n">job</span><span class="p">;</span>
  <span class="cm">/* waitpid 手册和网上关于它的只言片语拼凑出来的 */</span>
  <span class="cm">/* 为什么代码是这样的？目前的理解来说也给不出一个完全自洽的解释 */</span>
  <span class="cm">/* 最开始 waitpid 第二个参数是 NULL, 无法通过 trace16 的验证 */</span>
  <span class="cm">/* 这样的话，./tsh 无法捕捉从进程中发送的 SIGSTP 和 SIGINT */</span>
  <span class="k">while</span><span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WUNTRACED</span><span class="o">|</span><span class="n">WNOHANG</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>	      <span class="cm">/* process is exited in normal way */</span>
	<span class="p">{</span>
	  <span class="n">deletejob</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>	      <span class="cm">/* process is terminated by a signal */</span>
	<span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">"Job [%d] (%d) terminated by signal %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid2jid</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">pid</span><span class="p">,</span> <span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	  <span class="n">deletejob</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>	      <span class="cm">/* process is stop because of a signal */</span>
	<span class="p">{</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">"Job [%d] (%d) stopped by signal %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid2jid</span><span class="p">(</span><span class="n">pid</span><span class="p">),</span> <span class="n">pid</span><span class="p">,</span> <span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	  <span class="n">job</span> <span class="o">=</span> <span class="n">getjobpid</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	  <span class="k">if</span><span class="p">(</span><span class="n">job</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="n">job</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-org38cb018" class="outline-3">
<h3 id="org38cb018">sigint_handler</h3>
<div class="outline-text-3" id="text-org38cb018">
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">sigint_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="kt">pid_t</span> <span class="n">fpid</span><span class="p">;</span>
  <span class="n">fpid</span> <span class="o">=</span> <span class="n">fgpid</span><span class="p">(</span><span class="n">jobs</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">fpid</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* kill 这个用法在 do_bgfg 中的 kill 调用前注释讲过*/</span>
      <span class="n">kill</span><span class="p">(</span><span class="o">-</span><span class="n">fpid</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-org464963f" class="outline-3">
<h3 id="org464963f">sigstp_handler</h3>
<div class="outline-text-3" id="text-org464963f">
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">sigtstp_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> 
<span class="p">{</span>
  <span class="kt">pid_t</span> <span class="n">fpid</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">job_t</span> <span class="o">*</span> <span class="n">fjob</span><span class="p">;</span>
  <span class="n">fpid</span> <span class="o">=</span> <span class="n">fgpid</span><span class="p">(</span><span class="n">jobs</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">fpid</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">fjob</span> <span class="o">=</span> <span class="n">getjobpid</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="n">fpid</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">fjob</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">==</span><span class="n">ST</span><span class="p">)</span>
	<span class="p">{</span>
	  <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="cm">/* kill 这个用法在 do_bgfg 中的 kill 调用前注释讲过*/</span>
      <span class="n">kill</span><span class="p">(</span><span class="o">-</span><span class="n">fpid</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
            
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="https-zero4drift-github-io",
            disqus_url="https://zero4drift.github.io/posts/csapp-shlab-jie-ti-si-lu-ji-lu/",
        disqus_title="CSAPP-shlab \u89e3\u9898\u601d\u8def\u8bb0\u5f55",
        disqus_identifier="cache/posts/csapp-shlab-jie-ti-si-lu-ji-lu.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        
    


        </div>
    </div>

    
    <footer><div class="container">
            <div class="social">



                <div class="social-entry">
                    <a href="../../rss.xml" target="_blank">
                        <i class="fa fa-rss"></i> 
                    </a>
                </div>
            </div>
                <div class="copyright">
                    Contents © 2019         <a href="mailto:fang0052@e.ntu.edu.sg">zero4drift</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
                    
                </div>
           
        </div>
    </footer><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?06e0ade16d98033ac1aad78106d873c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script src="../../assets/js/all-nocdn.js" type="text/javascript"></script>
</body>
</html>
