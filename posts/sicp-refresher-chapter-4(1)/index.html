<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Refresher of SICP chapter 4.1 Metalinguistic Abstraction 元语言抽象">
<meta name="viewport" content="width=device-width">
<title>SICP-Refresher-Chapter-4(1) | 钉钉是世界上最傻逼的app</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://zero4drift.github.io/posts/sicp-refresher-chapter-4%281%29/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="zero4drift">
<meta property="og:site_name" content="钉钉是世界上最傻逼的app">
<meta property="og:title" content="SICP-Refresher-Chapter-4(1)">
<meta property="og:url" content="https://zero4drift.github.io/posts/sicp-refresher-chapter-4%281%29/">
<meta property="og:description" content="Refresher of SICP chapter 4.1 Metalinguistic Abstraction 元语言抽象">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-01-09T19:01:21+08:00">
<meta property="article:tag" content="Scheme">
<meta property="article:tag" content="SICP">
</head>
<body>
    

    <header id="header" class="navbar"><div class="container">
            
    <div class="brand">

        <div class="brand-text">
            <a href="https://zero4drift.github.io/" title="钉钉是世界上最傻逼的app" rel="home">
                钉钉是世界上最傻逼的app
            </a>
        </div>

        <a id="btn-toggle-nav" class="navbar-toggle">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
    </div>

            
    <nav class="navbar-collapse collapse"><ul class="nav">
<li><a href="../../archive.html">Archive</a></li>
                <li><a href="https://github.com/zero4drift">Github</a></li>
                <li><a href="../../categories/">Tags</a></li>
                <li><a href="../../rss.xml">RSS feed</a></li>
    
    
    </ul></nav>
</div>
    </header><div class="header-padding"> </div>

    
    <div class="post-header">
        <div class="container">
            <div class="title">
                SICP-Refresher-Chapter-4(1)
            </div>
        </div>
    </div>

    <div class="post-meta">
      <div class="container">
	<div class="meta clearfix">
	  <div class="authordate">
	    <time class="timeago" datetime="2019-01-09T19:01:21+08:00">2019/01/09</time>
</div>
	  <div class="post-tags">
	    <div class="tag">
	      <a href="../../categories/scheme/" rel="tag">Scheme</a>
	    </div>
	    <div class="tag">
	      <a href="../../categories/sicp/" rel="tag">SICP</a>
	    </div>
	  </div>
	</div>
      </div>
    </div>
    
    
    <div id="post-main" class="main">
        <div class="container">
        <div id="outline-container-orge3bfcf7" class="outline-2">
<h2 id="orge3bfcf7">第四章</h2>
<div class="outline-text-2" id="text-orge3bfcf7">
<p>
写在前面：本章代码并没有实际运行检查过（前三章基本没问题），并不保证 bug-free。 
</p>

<ol class="org-ol">
<li>建立新语言是在工程设计中控制复杂性的一种威力强大的工作策略，我们常常能通过
采用一种新语言而提升处理复杂问题的能力，因为新语言可能使我们以一种完全不同
的方式，利用不同的原语，不同的组合方式和抽象方式去描述（因此也是思考）所面
对的问题，而这些都是为了手头需要处理的问题而专门打造的；</li>
<li>元语言抽象就是建立新的语言；</li>
<li>把这一点看作是程序设计中最基本的思想一点也不过分: <b>求值器决定了一个程序设计
语言中各种表达式的意义而它本身也不过就是另一个程序</b>;</li>
<li>处理大规模计算系统的技术，与构造新的程序设计语言的技术有着紧密的联系，而计
算机科学本身不过（也不更少）就是有关如何构造适当的描述语言的学科；</li>
</ol>
</div>

<div id="outline-container-orgf21b6d5" class="outline-3">
<h3 id="orgf21b6d5">元循环求值器</h3>
<div class="outline-text-3" id="text-orgf21b6d5">
<ol class="org-ol">
<li>用与被求值的语言同样的语言写出的求值器被称为 <b>元循环</b>;</li>
<li>从根本上说，元循环求值器也就是 3.2 节所描述求值的环境模形的一个 scheme 表
达形式，该模形包括两个部分：
<ol class="org-ol">
<li>在求值一个组合式（一个不是特殊形式的复合表达式）时，首先求值其中的子表
达式，而后将运算符子表达式的值作用于运算对象子表达式的值；</li>
<li>在将一个复合过程应用于一集实际参数时，我们在一个新的环境里求值这个过程
的体，构造这一环境的方式就是用一个框架扩充该过程对象的环境部分，框架中
包含的是这个过程的各个形式参数与这一过程应用的各个实际参数的约束；</li>
</ol>
</li>
<li>上述两条规则描述了求值过程的核心部分，也就是它的基本循环，在这一循环中，表
达式在环境中的求值被归约到过程对实际参数的应用，而这种应用又被规约到新的表
达式在新的环境中的求值，如此下去，直至我们下降到符号（其值可以在环境中找到）
或者基本过程（它们可以直接应用）；</li>
</ol>
</div>

<div id="outline-container-org2707f0d" class="outline-4">
<h4 id="org2707f0d">求值器的内核</h4>
<div class="outline-text-4" id="text-org2707f0d">
<ol class="org-ol">
<li>求值过程可以描述为两个过程 eval 和 apply 之间的相互作用；</li>
<li>eval 的参数是一个表达式和一个环境，eval 对表达式进行分类，依次引导自己的
求值工作，eval 的构造就像是一个针对被求值表达式的语法类型的分情况分析；</li>
<li>apply 有两个参数，一个是过程，一个是该过程应该去应用的实际参数的表；</li>
<li>看懂代码就能理解。</li>
</ol>
</div>
</div>

<div id="outline-container-org0ced4f4" class="outline-4">
<h4 id="org0ced4f4">练习 4.1</h4>
<div class="outline-text-4" id="text-org0ced4f4">
<div class="highlight"><pre><span></span>    <span class="c1">;; the one always computes the value from left to right</span>

    <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">list-of-values-lr</span> <span class="nv">exps</span> <span class="nv">env</span><span class="p">)</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">no-operands?</span> <span class="nv">exps</span><span class="p">)</span>
	  <span class="o">'</span><span class="p">()</span>
	  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">first-operand</span> <span class="nv">exps</span><span class="p">)</span> <span class="nv">env</span><span class="p">)))</span>
	    <span class="p">(</span><span class="nb">cons </span><span class="nv">first</span>
		  <span class="p">(</span><span class="nf">list-of-values-lr</span> <span class="p">(</span><span class="nf">rest-operands</span> <span class="nv">exps</span><span class="p">)</span> <span class="nv">env</span><span class="p">)))))</span>

    <span class="c1">;; the one always computes the value from right to left</span>

    <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">list-of-values-rl</span> <span class="nv">exps</span> <span class="nv">env</span><span class="p">)</span>
      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">no-operands?</span> <span class="nv">exps</span><span class="p">)</span>
	  <span class="o">'</span><span class="p">()</span>
	  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">rest-values</span> <span class="p">(</span><span class="nf">list-of-values-rl</span> <span class="p">(</span><span class="nf">rest-operands</span> <span class="nv">exps</span><span class="p">)</span> <span class="nv">env</span><span class="p">)))</span>
	    <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">first-operand</span> <span class="nv">exps</span><span class="p">)</span> <span class="nv">env</span><span class="p">)</span>
		  <span class="nv">rest-values</span><span class="p">))))</span>
</pre></div>
</div>
</div>

<div id="outline-container-org8940274" class="outline-4">
<h4 id="org8940274">表达式的表示</h4>
<div class="outline-text-4" id="text-org8940274">
<ol class="org-ol">
<li>注意派生表达式的逻辑；</li>
</ol>
</div>
</div>

<div id="outline-container-org4f52db1" class="outline-4">
<h4 id="org4f52db1">练习 4.2-4.10</h4>
<div class="outline-text-4" id="text-org4f52db1">
</div>
<ul class="org-ul">
<li>
<a id="org8e3f8a1"></a>4.2<br><div class="outline-text-5" id="text-org8e3f8a1">
<div class="highlight"><pre><span></span>     <span class="c1">;; a</span>

     <span class="c1">;; 检查过程语法形式的谓词过程</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">application?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">pair? </span><span class="nv">exp</span><span class="p">))</span>
     <span class="c1">;; 而很多不是过程调用的表达式其实都是序对，但不能用过程调用的形式处理</span>

     <span class="c1">;; b</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">application?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'call</span><span class="p">))</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">operator</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr </span><span class="nv">exp</span><span class="p">))</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">operands</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cddr </span><span class="nv">exp</span><span class="p">))</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">no-operands?</span> <span class="nv">ops</span><span class="p">)</span> <span class="p">(</span><span class="nb">null? </span><span class="nv">ops</span><span class="p">))</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">first-operand</span> <span class="nv">ops</span><span class="p">)</span> <span class="p">(</span><span class="nb">car </span><span class="nv">ops</span><span class="p">))</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">rest-operands</span> <span class="nv">ops</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">ops</span><span class="p">))</span>
</pre></div>
</div>
</li>

<li>
<a id="org81cf100"></a>4.3<br><div class="outline-text-5" id="text-org81cf100">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">type-tag</span> <span class="nv">datum</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">pair? </span><span class="nv">datum</span><span class="p">)</span>
	   <span class="p">(</span><span class="nb">car </span><span class="nv">datum</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">error</span> <span class="s">"Bad tagged datum -- TYPE-TAG"</span> <span class="nv">datum</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nb">eval </span><span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">tag</span> <span class="p">(</span><span class="nf">type-tag</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">proc</span> <span class="p">(</span><span class="nf">get</span> <span class="ss">'eval</span> <span class="nv">tag</span><span class="p">)))</span>
	   <span class="p">(</span><span class="k">if </span><span class="nv">proc</span>
	       <span class="p">(</span><span class="nf">proc</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
	       <span class="p">(</span><span class="nf">error</span> <span class="s">"Unknown expression type -- EVAL"</span>
		      <span class="nv">exp</span><span class="p">)))))</span>

     <span class="c1">;; number: scheme-number</span>
     <span class="c1">;; string: scheme-string</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-self-evaluation</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'scheme-number</span> <span class="nv">eval-self-evaluation</span><span class="p">)</span>
     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'scheme-string</span> <span class="nv">eval-self-evaluation</span><span class="p">)</span>

     <span class="c1">;; variable: 'quote</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-variable</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">text-of-quotation</span> <span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'quote</span> <span class="nv">eval-variable</span><span class="p">)</span>

     <span class="c1">;; assignment: set!</span>

     <span class="c1">;; the original eval-assignment</span>
     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'set!</span> <span class="nv">eval-assignment</span><span class="p">)</span>

     <span class="c1">;; definition: define</span>

     <span class="c1">;; the original eval-definition</span>
     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'define</span> <span class="nv">eval-definition</span><span class="p">)</span>

     <span class="c1">;; lambda: lambda</span>

     <span class="c1">;; should modify the original make-procedure</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-procedure-lambda</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">parameters</span> <span class="p">(</span><span class="nf">lambda-parameters</span> <span class="nv">exp</span><span class="p">))</span>
	     <span class="p">(</span><span class="nf">body</span> <span class="p">(</span><span class="nf">lambda-body</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="nf">make-procedure</span> <span class="nv">parameters</span> <span class="nv">body</span> <span class="nv">env</span><span class="p">)))</span>

     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'lambda</span> <span class="nv">make-procedure-lambda</span><span class="p">)</span>

     <span class="c1">;; if: if</span>

     <span class="c1">;; the original eval-if</span>
     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'if</span> <span class="nv">eval-if</span><span class="p">)</span>

     <span class="c1">;; begin: begin</span>

     <span class="c1">;; should modify the original eval-sequence</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-sequence-begin</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">actions</span> <span class="p">(</span><span class="nf">begin-actons</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="nf">eval-sequence</span> <span class="nv">actions</span> <span class="nv">env</span><span class="p">)))</span>

     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'begin</span> <span class="nv">eval-sequence-begin</span><span class="p">)</span>

     <span class="c1">;; cond: cond</span>
     <span class="c1">;; should modify the original handle method</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-cond</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">transfer</span> <span class="p">(</span><span class="nf">cond-&gt;if</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="nb">eval </span><span class="nv">transfer</span> <span class="nv">env</span><span class="p">)))</span>

     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'cond</span> <span class="nv">eval-cond</span><span class="p">)</span>

     <span class="c1">;; application: call</span>
     <span class="c1">;; based on the procedures defined in exercise 4.2 b</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-application</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">apply </span><span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">operator</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">)</span>
	      <span class="p">(</span><span class="nf">list-of-values</span> <span class="p">(</span><span class="nf">operands</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">)))</span>

     <span class="p">(</span><span class="nf">put</span> <span class="ss">'eval</span> <span class="ss">'call</span> <span class="nv">eval-application</span><span class="p">)</span>
</pre></div>
</div>
</li>

<li>
<a id="org2d04725"></a>4.4<br><div class="outline-text-5" id="text-org2d04725">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">and?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'and</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">or?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'or</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">all-predicates</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">first-predicate</span> <span class="nv">predicates</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">predicates</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">rest-predicates</span> <span class="nv">predicates</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">predicates</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-and</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">predicates</span> <span class="p">(</span><span class="nf">all-predicates</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nf">first-predicate</span> <span class="nv">predicates</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">rest</span> <span class="p">(</span><span class="nf">rest-predicates</span> <span class="nv">predicates</span><span class="p">)))</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nb">eval </span><span class="nv">first</span> <span class="nv">env</span><span class="p">)))</span>
	     <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">not </span><span class="nv">result</span><span class="p">)</span> <span class="nv">false</span><span class="p">)</span>
		   <span class="p">((</span><span class="k">and </span><span class="p">(</span><span class="nb">null? </span><span class="nv">rest</span><span class="p">)</span> <span class="nv">result</span><span class="p">)</span> <span class="nv">result</span><span class="p">)</span>
		   <span class="p">(</span><span class="nf">result</span> <span class="p">(</span><span class="nf">eval-and</span> <span class="nv">rest</span> <span class="nv">env</span><span class="p">)))))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-or</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">predicates</span> <span class="p">(</span><span class="nf">all-predicates</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nf">first-predicate</span> <span class="nv">predicates</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">rest</span> <span class="p">(</span><span class="nf">rest-predicates</span> <span class="nv">predicates</span><span class="p">)))</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nb">eval </span><span class="nv">first</span> <span class="nv">env</span><span class="p">)))</span>
	     <span class="p">(</span><span class="k">cond </span><span class="p">(</span><span class="nf">result</span> <span class="nv">true</span><span class="p">)</span>
		   <span class="p">(</span><span class="k">and </span><span class="p">(</span><span class="nb">null? </span><span class="nv">rest</span><span class="p">)</span> <span class="p">(</span><span class="nb">not </span><span class="nv">result</span><span class="p">)</span> <span class="nv">false</span><span class="p">)</span>
		   <span class="p">((</span><span class="nb">not </span><span class="nv">result</span><span class="p">)</span> <span class="nv">eval-or</span> <span class="nv">rest</span> <span class="nv">env</span><span class="p">))))))</span>

     <span class="c1">;; derived expression based on if</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-and</span> <span class="nv">predicates</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">list </span><span class="ss">'and</span> <span class="nv">predicates</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-or</span> <span class="nv">predicates</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">list </span><span class="ss">'or</span> <span class="nv">predicates</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">and-&gt;if</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">predicates</span> <span class="p">(</span><span class="nf">all-predicates</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nf">first-predicate</span> <span class="nv">predicates</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">rest</span> <span class="p">(</span><span class="nf">rest-predicates</span> <span class="nv">predicates</span><span class="p">)))</span>
	   <span class="p">(</span><span class="nf">make-if</span>
	    <span class="nv">first</span>
	    <span class="p">(</span><span class="nf">make-and</span> <span class="nv">rest</span><span class="p">)</span>
	    <span class="nv">first</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">or-&gt;cond</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">predicates</span> <span class="p">(</span><span class="nf">all-predicates</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nf">first-predicate</span> <span class="nv">predicates</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">rest</span> <span class="p">(</span><span class="nf">rest-predicates</span> <span class="nv">predicates</span><span class="p">)))</span>
	   <span class="p">(</span><span class="nf">make-if</span>
	    <span class="nv">first</span>
	    <span class="nv">first</span>
	    <span class="p">(</span><span class="nf">make-or</span> <span class="nv">rest</span><span class="p">)))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-and</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">and-&gt;if</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-or</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">or-&gt;if</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="c1">;; so just implement the eval-and and eval-or in</span>
     <span class="c1">;; the original eval procedure</span>
</pre></div>
</div>
</li>

<li>
<a id="org3907592"></a>4.5<br><div class="outline-text-5" id="text-org3907592">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'cond</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-clauses</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-else-clause?</span> <span class="nv">clause</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eq? </span><span class="p">(</span><span class="nf">cond-predicate</span> <span class="nv">clause</span><span class="p">)</span> <span class="ss">'else</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-special-clause?</span> <span class="nv">clause</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eq? </span><span class="ss">'=&gt;</span> <span class="p">(</span><span class="nb">cadr </span><span class="nv">clause</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-special-clause-proc</span> <span class="nv">clause</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">caddr </span><span class="nv">clause</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-predicate</span> <span class="nv">clause</span><span class="p">)</span> <span class="p">(</span><span class="nb">car </span><span class="nv">clause</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-actions</span> <span class="nv">clause</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">clause</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">cond-&gt;if</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">expand-clauses</span> <span class="p">(</span><span class="nf">cond-clauses</span> <span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">expand-clauses</span> <span class="nv">clauses</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">clauses</span><span class="p">)</span>
	   <span class="ss">'false</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nb">car </span><span class="nv">clauses</span><span class="p">))</span>
		 <span class="p">(</span><span class="nf">rest</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">clauses</span><span class="p">)))</span>
	     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">cond-else-clause?</span> <span class="nv">first</span><span class="p">)</span>
		 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">rest</span><span class="p">)</span>
		     <span class="p">(</span><span class="nf">sequence-&gt;exp</span> <span class="p">(</span><span class="nf">cond-actions</span> <span class="nv">first</span><span class="p">))</span>
		     <span class="p">(</span><span class="nf">error</span> <span class="s">"ELSE clause isn't last -- COND-&gt;IF"</span>
			    <span class="nv">clauses</span><span class="p">))</span>
		 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">p</span> <span class="p">(</span><span class="nf">cond-predicate</span> <span class="nv">first</span><span class="p">)))</span>
		   <span class="p">(</span><span class="nf">make-if</span>
		    <span class="nv">p</span>
		    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">cond-special-clause?</span> <span class="nv">first</span><span class="p">)</span>
			<span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">cond-special-clause-proc</span> <span class="nv">first</span><span class="p">)</span> <span class="nv">p</span><span class="p">)</span>
			<span class="p">(</span><span class="nf">sequence-&gt;exp</span> <span class="p">(</span><span class="nf">cond-actions</span> <span class="nv">first</span><span class="p">)))</span>
		    <span class="p">(</span><span class="nf">expand-clauses</span> <span class="nv">rest</span><span class="p">)))))))</span>
</pre></div>
</div>
</li>

<li>
<a id="org3484b2c"></a>4.6<br><div class="outline-text-5" id="text-org3484b2c">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'let</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-exps</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">var</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">expression</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-&gt;application</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">transfer</span> <span class="p">(</span><span class="nf">let-exps</span> <span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">transfer</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">bindings</span> <span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">))</span>
	     <span class="p">(</span><span class="nf">body</span> <span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">var-list</span> <span class="p">(</span><span class="nb">map </span><span class="nv">var</span> <span class="nv">bindings</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">exp-list</span> <span class="p">(</span><span class="nb">map </span><span class="nv">expression</span> <span class="nv">bindings</span><span class="p">)))</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">proc</span> <span class="p">(</span><span class="nf">make-lambda</span> <span class="nv">var-list</span> <span class="nv">body</span><span class="p">)))</span>
	     <span class="p">(</span><span class="nb">list </span><span class="nv">proc</span> <span class="nv">exp-list</span><span class="p">)))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-let</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">let-&gt;application</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="c1">;; implement let? and eval-let in eval</span>
</pre></div>
</div>
</li>

<li>
<a id="org731bb6e"></a>4.7<br><div class="outline-text-5" id="text-org731bb6e">
<div class="highlight"><pre><span></span>     <span class="c1">;; all bacause of the environment bindings' update &amp; access</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let*?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'let*</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let*-exps</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let*-bindings</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let*-body</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cddr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-let</span> <span class="nv">binding</span> <span class="nv">body</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cons </span><span class="ss">'let</span> <span class="p">(</span><span class="nb">list </span><span class="nv">binding</span><span class="p">)</span> <span class="nv">body</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-neseted-lets</span> <span class="nv">bindings</span> <span class="nv">body</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">bindings</span><span class="p">))</span>
	   <span class="p">(</span><span class="nf">make-let</span> <span class="p">(</span><span class="nb">car </span><span class="nv">bindings</span><span class="p">)</span> <span class="nv">body</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">make-let</span> <span class="p">(</span><span class="nb">car </span><span class="nv">bindings</span><span class="p">)</span>
		     <span class="p">(</span><span class="nf">make-neseted-lets</span>
		      <span class="p">(</span><span class="nb">cdr </span><span class="nv">bindings</span><span class="p">)</span>
		      <span class="nv">body</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let*-&gt;nested-lets</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">make-neseted-lets</span>
	<span class="p">(</span><span class="nf">let*-bindings</span> <span class="p">(</span><span class="nf">let*-exps</span> <span class="nv">exp</span><span class="p">))</span>
	<span class="p">(</span><span class="nf">let*-body</span> <span class="p">(</span><span class="nf">let*-exps</span> <span class="nv">exp</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-let*</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">let*-&gt;nested-lets</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>
     <span class="c1">;; nested-let makes no difference when compared with let*</span>
     <span class="c1">;; thanks to the environment structure</span>

     <span class="c1">;; just implement let*? and eval-let* in eval</span>
</pre></div>
</div>
</li>

<li>
<a id="orgb357274"></a>4.8<br><div class="outline-text-5" id="text-orgb357274">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'let</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-exps</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-procedure?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">symbol? </span><span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-procedure-var</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-procedure-bindings</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-procedure-body</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cddr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-begin</span> <span class="nv">seq</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cons </span><span class="ss">'begin</span> <span class="nv">seq</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-define-p</span> <span class="nv">v</span> <span class="nv">p</span> <span class="nv">b</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cons </span><span class="ss">'define</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">v</span> <span class="nv">p</span><span class="p">)</span> <span class="nv">b</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">var</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">expression</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-&gt;application</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">transfer</span> <span class="p">(</span><span class="nf">let-exps</span> <span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">transfer</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">let-p?</span> <span class="p">(</span><span class="nf">let-procedure?</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">bindings</span>
		<span class="p">(</span><span class="k">if </span><span class="nv">let-p?</span>
		    <span class="p">(</span><span class="nf">let-procedure-bindings</span> <span class="nv">exp</span><span class="p">)</span>
		    <span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">)))</span>
	       <span class="p">(</span><span class="nf">body</span>
		<span class="p">(</span><span class="k">if </span><span class="nv">let-p?</span>
		    <span class="p">(</span><span class="nf">let-procedure-body</span> <span class="nv">exp</span><span class="p">)</span>
		    <span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">))))</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">var-list</span>
		  <span class="p">(</span><span class="nb">map </span><span class="nv">var</span> <span class="nv">bindings</span><span class="p">))</span>
		 <span class="p">(</span><span class="nf">exp-list</span>
		  <span class="p">(</span><span class="nb">map </span><span class="nv">expression</span> <span class="nv">bindings</span><span class="p">)))</span>
	     <span class="p">(</span><span class="k">if </span><span class="nv">let-p?</span>
		 <span class="p">(</span><span class="nf">make-begin</span>
		  <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">make-define-p</span>
		    <span class="p">(</span><span class="nf">let-procedure-var</span> <span class="nv">exp</span><span class="p">)</span>
		    <span class="nv">var-list</span>
		    <span class="nv">body</span><span class="p">)</span>
		   <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">let-procedure-var</span> <span class="nv">exp</span><span class="p">)</span>
			 <span class="nv">exp-list</span><span class="p">)))</span>
		 <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">make-lambda</span> <span class="nv">var-list</span> <span class="nv">body</span><span class="p">)</span>
		       <span class="nv">exp-list</span><span class="p">))))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-let</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">let-&gt;application</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="c1">;; implement let? and eval-let in eval</span>
</pre></div>
</div>
</li>

<li>
<a id="orga8e649e"></a>4.9<br><div class="outline-text-5" id="text-orga8e649e">
<div class="highlight"><pre><span></span>     <span class="c1">;; first eval self-defined special procedure through eval procedure</span>

     <span class="c1">;; show the structure of while by making a definition</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">while</span> <span class="nv">exp</span> <span class="nv">proc</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="nv">exp</span>
	   <span class="p">(</span><span class="k">begin </span><span class="nv">proc</span>
		  <span class="p">(</span><span class="nf">while</span> <span class="nv">exp</span> <span class="nv">proc</span><span class="p">))</span>
	   <span class="ss">'finished</span><span class="p">))</span>
     <span class="c1">;; so while is composed of if and begin</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">while?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'while</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">while-predicate</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">while-actions</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">make-begin</span>
	<span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">caddr </span><span class="nv">exp</span><span class="p">)</span>
	      <span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="nv">while-alternative</span>
       <span class="ss">'finished</span><span class="p">)</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">while-transfer</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">make-if</span>
	<span class="p">(</span><span class="nf">while-predicate</span> <span class="nv">exp</span><span class="p">)</span>
	<span class="p">(</span><span class="nf">while-actions</span> <span class="nv">exp</span><span class="p">)</span>
	<span class="nv">while-alternative</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-while</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">while-transfer</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="c1">;; just implement while? and eval-while in eval</span>
</pre></div>
</div>
</li>

<li>
<a id="orgbcbf3d4"></a>4.10<br><div class="outline-text-5" id="text-orgbcbf3d4">
<div class="highlight"><pre><span></span>     <span class="c1">;; 复合表达式中运算符表达式在最后一个，前面所有的都是运算对象表达式</span>
     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">last-one</span> <span class="nv">lst</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">lst</span><span class="p">))</span>
	   <span class="p">(</span><span class="nb">car </span><span class="nv">lst</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">last-one</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">lst</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">operator</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">last-one</span> <span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">operands</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>
	   <span class="o">'</span><span class="p">()</span>
	   <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">)</span>
		 <span class="p">(</span><span class="nf">operands</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">)))))</span>
</pre></div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6786d3a" class="outline-4">
<h4 id="org6786d3a">求值器数据结构</h4>
<div class="outline-text-4" id="text-org6786d3a">
<ol class="org-ol">
<li>理解代码就没问题；</li>
</ol>
</div>
</div>

<div id="outline-container-org879c7c0" class="outline-4">
<h4 id="org879c7c0">练习 4.11-4.13</h4>
<div class="outline-text-4" id="text-org879c7c0">
</div>
<ul class="org-ul">
<li>
<a id="orgd6c71fe"></a>4.11<br><div class="outline-text-5" id="text-orgd6c71fe">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-frame</span> <span class="nv">bindings</span><span class="p">)</span>
       <span class="nv">bindings</span><span class="p">)</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-binding</span> <span class="nv">var</span> <span class="nv">val</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cons </span><span class="nv">var</span> <span class="nv">val</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-bindings</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">map </span><span class="nv">make-binding</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">bindings-frame</span> <span class="nv">frame</span><span class="p">)</span>
       <span class="nv">frame</span><span class="p">)</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">set-value!</span> <span class="nv">binding</span> <span class="nv">value</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">set-cdr! </span><span class="nv">binding</span> <span class="nv">value</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">first-binding</span> <span class="nv">bindings</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">bindings</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">rest-bindings</span> <span class="nv">bindings</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">bindings</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">null-bindings?</span> <span class="nv">bindings</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">null? </span><span class="nv">bindings</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">binding-variable</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">binding-value</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">add-binding-to-frame!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">new-binding</span> <span class="p">(</span><span class="nf">make-binding</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">)))</span>
	 <span class="p">(</span><span class="nb">cons </span><span class="nv">new-binding</span> <span class="nv">frame</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">extend-environment</span> <span class="nv">vars</span> <span class="nv">vals</span> <span class="nv">base-env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nb">length </span><span class="nv">vars</span><span class="p">)</span> <span class="p">(</span><span class="nb">length </span><span class="nv">vals</span><span class="p">))</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">bindings</span> <span class="p">(</span><span class="nf">make-bindings</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">)))</span>
	     <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">make-frame</span> <span class="nv">bindings</span><span class="p">)</span> <span class="nv">base-env</span><span class="p">))</span>
	   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt; </span><span class="p">(</span><span class="nb">length </span><span class="nv">vars</span><span class="p">)</span> <span class="p">(</span><span class="nb">length </span><span class="nv">vals</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">error</span> <span class="s">"Too many arguments supplied"</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">)</span>
	       <span class="p">(</span><span class="nf">error</span> <span class="s">"Too few arguments supplied"</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">lookup-variable-value</span> <span class="nv">var</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">lookup</span> <span class="nv">var</span> <span class="nv">bindings</span><span class="p">)</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">null-bindings?</span> <span class="nv">bindings</span><span class="p">)</span>
	     <span class="nv">false</span>
	     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nf">first-binding</span> <span class="nv">bindings</span><span class="p">)))</span>
	       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eq? </span><span class="nv">var</span> <span class="p">(</span><span class="nf">binding-variable</span> <span class="nv">first</span><span class="p">))</span>
		   <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">first</span><span class="p">)</span>
		   <span class="p">(</span><span class="nf">lookup</span> <span class="nv">var</span> <span class="p">(</span><span class="nf">rest-bindings</span> <span class="nv">bindings</span><span class="p">))))))</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eq? </span><span class="nv">env</span> <span class="nv">the-empty-environment</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">error</span> <span class="s">"Unbound variable"</span> <span class="nv">var</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">))</span>
		 <span class="p">(</span><span class="nf">base-env</span> <span class="p">(</span><span class="nf">enclosing-environment</span> <span class="nv">env</span><span class="p">)))</span>
	     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nf">lookup</span> <span class="nv">var</span> <span class="p">(</span><span class="nf">bindings-frame</span> <span class="nv">frame</span><span class="p">))))</span>
	       <span class="p">(</span><span class="k">if </span><span class="nv">result</span>
		   <span class="nv">result</span>
		   <span class="p">(</span><span class="nf">lookup-variable-value</span> <span class="nv">var</span> <span class="nv">base-env</span><span class="p">))))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">set-variable-value!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span> <span class="c1">;the former one has too many lets, try another style</span>
       <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span><span class="p">)</span>
	 <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">scan</span> <span class="nv">bindings</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nf">null-bindings?</span> <span class="nv">bindings</span><span class="p">)</span>
		  <span class="p">(</span><span class="nf">env-loop</span> <span class="p">(</span><span class="nf">enclosing-environment</span> <span class="nv">env</span><span class="p">)))</span>
		 <span class="p">((</span><span class="nb">eq? </span><span class="nv">var</span> <span class="p">(</span><span class="nf">binding-variable</span> <span class="p">(</span><span class="nf">first-binding</span> <span class="nv">bindings</span><span class="p">)))</span>
		  <span class="p">(</span><span class="nf">set-value!</span> <span class="p">(</span><span class="nf">first-binding</span> <span class="nv">bindings</span><span class="p">)</span> <span class="nv">val</span><span class="p">))</span>
		 <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">rest-bindings</span> <span class="nv">bindings</span><span class="p">)))))</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eq? </span><span class="nv">env</span> <span class="nv">the-empty-environment</span><span class="p">)</span>
	     <span class="p">(</span><span class="nf">error</span> <span class="s">"Unbound variable -- SET!"</span> <span class="nv">var</span><span class="p">)</span>
	     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">)))</span>
	       <span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">bindings-frame</span> <span class="nv">frame</span><span class="p">)))))</span>
       <span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">define-variable!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">scan</span> <span class="nv">bindings</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nf">null-bindings?</span> <span class="nv">bindings</span><span class="p">)</span>
		  <span class="p">(</span><span class="nf">add-binding-to-frame!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">))</span>
		 <span class="p">((</span><span class="nb">eq? </span><span class="nv">var</span> <span class="p">(</span><span class="nf">binding-variable</span> <span class="p">(</span><span class="nf">first-binding</span> <span class="nv">bindings</span><span class="p">)))</span>
		  <span class="p">(</span><span class="nf">set-value!</span> <span class="p">(</span><span class="nf">first-binding</span> <span class="nv">bindings</span><span class="p">)</span> <span class="nv">val</span><span class="p">))</span>
		 <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">rest-bindings</span> <span class="nv">bindings</span><span class="p">)))))</span>
	 <span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">bindings-frame</span> <span class="nv">frame</span><span class="p">))))</span>
</pre></div>
</div>
</li>

<li>
<a id="orgcb85fd2"></a>4.12<br><div class="outline-text-5" id="text-orgcb85fd2">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">scan</span> <span class="nv">vars</span> <span class="nv">vals</span> <span class="nv">var</span><span class="p">)</span>
       <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">null? </span><span class="nv">vars</span><span class="p">)</span> <span class="nv">false</span><span class="p">)</span>
	     <span class="p">((</span><span class="nb">eq? </span><span class="p">(</span><span class="nb">car </span><span class="nv">vars</span><span class="p">)</span> <span class="nv">var</span><span class="p">)</span>
	      <span class="nv">vals</span><span class="p">)</span>
	     <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vars</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vals</span><span class="p">)</span> <span class="nv">var</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span> <span class="nv">proc</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eq? </span><span class="nv">env</span> <span class="nv">the-empty-environment</span><span class="p">)</span>
	   <span class="nv">false</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">)))</span>
	     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">frame-variables</span> <span class="nv">frame</span><span class="p">)</span>
				 <span class="p">(</span><span class="nf">frame-values</span> <span class="nv">frame</span><span class="p">)</span>
				 <span class="nv">var</span><span class="p">)))</span>
	       <span class="p">(</span><span class="k">if </span><span class="nv">result</span>
		   <span class="p">(</span><span class="nf">proc</span> <span class="nv">result</span><span class="p">)</span>
		   <span class="p">(</span><span class="nf">env-loop</span> <span class="p">(</span><span class="nf">enclosing-environment</span> <span class="nv">env</span><span class="p">)))))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">lookup-variable-value</span> <span class="nv">var</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span> <span class="nv">car</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">if </span><span class="nv">result</span>
	     <span class="nv">result</span>
	     <span class="p">(</span><span class="nf">error</span> <span class="s">"Unbound variable"</span> <span class="nv">var</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">set-variable-value!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">set-value!</span> <span class="nv">vals</span><span class="p">)</span>
	 <span class="p">(</span><span class="nb">set-car! </span><span class="nv">vals</span> <span class="nv">val</span><span class="p">))</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span> <span class="nv">set-value!</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="nv">result</span><span class="p">)</span>			<span class="c1">;though set-car! returns unspecific return value, (not result) is false</span>
	     <span class="p">(</span><span class="nf">error</span> <span class="s">"Unbound variable"</span> <span class="nv">var</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">define-variable!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">result</span> <span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">frame-variables</span> <span class="nv">frame</span><span class="p">)</span>
			     <span class="p">(</span><span class="nf">frame-values</span> <span class="nv">frame</span><span class="p">)</span>
			     <span class="nv">var</span><span class="p">)))</span>
	   <span class="p">(</span><span class="k">if </span><span class="nv">result</span>
	       <span class="p">(</span><span class="nb">set-car! </span><span class="nv">result</span> <span class="nv">val</span><span class="p">)</span>
	       <span class="p">(</span><span class="nf">add-binding-to-frame!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">)))))</span>
</pre></div>
</div>
</li>

<li>
<a id="org671e503"></a>4.13<br><div class="outline-text-5" id="text-org671e503">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">unbound?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'unbound</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">unbound-var</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">make-unbound!</span> <span class="nv">var</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">list </span><span class="ss">'unbound</span> <span class="nv">var</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-unbound</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">unbound-variable!</span> <span class="p">(</span><span class="nf">unbound-var</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">unbound-variable!</span> <span class="nv">var</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">scan</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">null? </span><span class="nv">vars</span><span class="p">)</span>
		  <span class="ss">'ok</span><span class="p">)</span>
		 <span class="p">((</span><span class="nb">eq? </span><span class="nv">var</span> <span class="p">(</span><span class="nb">car </span><span class="nv">vars</span><span class="p">))</span>
		  <span class="p">(</span><span class="k">begin </span><span class="p">(</span><span class="k">set! </span><span class="nv">vars</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vars</span><span class="p">))</span>
			 <span class="p">(</span><span class="k">set! </span><span class="nv">vals</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vals</span><span class="p">))))</span>
		 <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vars</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vals</span><span class="p">)))))</span>
	 <span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">frame-variables</span> <span class="nv">frame</span><span class="p">)</span>
	       <span class="p">(</span><span class="nf">frame-values</span> <span class="nv">frame</span><span class="p">))))</span>

     <span class="c1">;; only delete the matched binding in the current environment</span>
     <span class="c1">;; cause that the same-name binding in outside environments</span>
     <span class="c1">;; may be utilized by other procedures</span>
     <span class="c1">;; it is a disaster for these procedures if all unbounded</span>
</pre></div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgfe7e959" class="outline-4">
<h4 id="orgfe7e959">作为程序运行这个求值器</h4>
<div class="outline-text-4" id="text-orgfe7e959">
<ol class="org-ol">
<li>只要看明白代码；</li>
</ol>
</div>
</div>

<div id="outline-container-org204cef2" class="outline-4">
<h4 id="org204cef2">练习 4.14</h4>
<div class="outline-text-4" id="text-org204cef2">
<div class="highlight"><pre><span></span>    <span class="c1">;; eva's way is passed because the map definition is implemented in eval</span>
    <span class="c1">;; so when this map procedure is applied, eval looks for its definition binding</span>
    <span class="c1">;; then applies arguments and env to the map definition body</span>

    <span class="c1">;; louis takes the map procedure as the original primitive procedure in eval</span>
    <span class="c1">;; so when the map application is processed</span>
    <span class="c1">;; since it is a primitive procedure</span>
    <span class="c1">;; the apply internal result is like</span>
    <span class="c1">;; (apply-primitive-procedure procedure arguments)</span>
    <span class="c1">;; for example</span>
    <span class="c1">;; '(map '* (1 2 3) (4 5 6))</span>
    <span class="c1">;; but in the internal result</span>
    <span class="c1">;; (apply-in-underlying-scheme map (list 'primitive *) (1 2 3) (4 5 6))</span>
    <span class="c1">;; apply (list 'primitive *) to args in eval would fall into application branch</span>
    <span class="c1">;; but at last 'primitive is a symbol with no binding</span>
    <span class="c1">;; so it's failed</span>
</pre></div>
</div>
</div>

<div id="outline-container-org122183f" class="outline-4">
<h4 id="org122183f">将数据作为程序</h4>
<div class="outline-text-4" id="text-org122183f">
<ol class="org-ol">
<li>关于程序意义的一种操作式观点，就是将程序看作一种抽象的（可能无穷大的）机
器的一个描述，我们也可以把求值器看作是一部非常特殊的机器，它要求以一部机
器的描述作为输入，给定了一个输入以后，求值器就能够规划自己的行为，模拟被
描述机器的执行过程；</li>
<li>求值器的另一惊人方面，在于它就像是我们的程序设计语言所操作的数据对象和这
个程序设计语言本身之间的一座桥梁；</li>
</ol>
</div>
</div>

<div id="outline-container-org6145eb7" class="outline-4">
<h4 id="org6145eb7">练习 4.15</h4>
<div class="outline-text-4" id="text-org6145eb7">
<div class="highlight"><pre><span></span>    <span class="c1">;; 引起悖论</span>
    <span class="c1">;; (try try) 如果可以终止，在 try 的过程体那将执行 (run-forever);</span>
    <span class="c1">;; 如果不可以终止，将返回 'halted。</span>

    <span class="c1">;; 所以不可能写出一个过程 halts?</span>
</pre></div>
</div>
</div>

<div id="outline-container-org766bb38" class="outline-4">
<h4 id="org766bb38">内部定义</h4>
<div class="outline-text-4" id="text-org766bb38">
<ol class="org-ol">
<li>存在一些处理内部定义的方法，可以使内部名字的定义真正具有同样的作用域（不
然就会对代码形式有一些限制）；</li>
</ol>
</div>
</div>

<div id="outline-container-orgcfc3b06" class="outline-4">
<h4 id="orgcfc3b06">练习 4.16-4.21</h4>
<div class="outline-text-4" id="text-orgcfc3b06">
</div>
<ul class="org-ul">
<li>
<a id="orgc5aba36"></a>4.16<br><div class="outline-text-5" id="text-orgc5aba36">
<div class="highlight"><pre><span></span>     <span class="c1">;; a</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">lookup-variable-value</span> <span class="nv">var</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span><span class="p">)</span>
	 <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">scan</span> <span class="nv">vars</span> <span class="nv">vals</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">null? </span><span class="nv">vars</span><span class="p">)</span>
		  <span class="p">(</span><span class="nf">env-loop</span> <span class="p">(</span><span class="nf">enclosing-environment</span> <span class="nv">env</span><span class="p">)))</span>
		 <span class="p">((</span><span class="nb">eq? </span><span class="nv">var</span> <span class="p">(</span><span class="nb">car </span><span class="nv">vars</span><span class="p">))</span>
		  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eq? </span><span class="p">(</span><span class="nb">car </span><span class="nv">vals</span><span class="p">)</span> <span class="ss">'*unassigned*</span><span class="p">)</span>
		      <span class="p">(</span><span class="nf">error</span> <span class="s">"Unassigned variable"</span> <span class="nv">var</span><span class="p">)</span>
		      <span class="p">(</span><span class="nb">car </span><span class="nv">vals</span><span class="p">)))</span>
		 <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vars</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">vals</span><span class="p">)))))</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eq? </span><span class="nv">env</span> <span class="nv">the-empty-environment</span><span class="p">)</span>
	     <span class="p">(</span><span class="nf">error</span> <span class="s">"Unbound variable"</span> <span class="nv">var</span><span class="p">)</span>
	     <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">frame</span> <span class="p">(</span><span class="nf">first-frame</span> <span class="nv">env</span><span class="p">)))</span>
	       <span class="p">(</span><span class="nf">scan</span> <span class="p">(</span><span class="nf">frame-variables</span> <span class="nv">frame</span><span class="p">)</span>
		     <span class="p">(</span><span class="nf">frame-values</span> <span class="nv">frame</span><span class="p">)))))</span>
       <span class="p">(</span><span class="nf">env-loop</span> <span class="nv">env</span><span class="p">))</span>

     <span class="c1">;; b</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">transfer-defines-let</span> <span class="nv">vars</span> <span class="nv">bodys</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">attached-unassigned</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="nv">i</span> <span class="ss">'*unassigned*</span><span class="p">))</span> <span class="nv">vars</span><span class="p">))</span>
	     <span class="p">(</span><span class="nf">transfer-set!-body</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">i</span> <span class="nv">j</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="ss">'set!</span> <span class="nv">i</span> <span class="nv">j</span><span class="p">))</span> <span class="nv">vars</span> <span class="nv">bodys</span><span class="p">)))</span>
	 <span class="p">(</span><span class="nb">cons </span><span class="ss">'let</span> <span class="nv">attached-unassigned</span> <span class="nv">transfer-set!-body</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">internal-defines</span> <span class="nv">body</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">body</span><span class="p">)</span>
	   <span class="o">'</span><span class="p">()</span>
	   <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">definition?</span> <span class="p">(</span><span class="nb">car </span><span class="nv">body</span><span class="p">))</span>
	       <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">car </span><span class="nv">body</span><span class="p">)</span>
		     <span class="p">(</span><span class="nf">internal-defines</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">body</span><span class="p">))))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">internal-body</span> <span class="nv">body</span><span class="p">)</span>
       <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">definition?</span> <span class="p">(</span><span class="nb">car </span><span class="nv">body</span><span class="p">)))</span>
	   <span class="nv">body</span>
	   <span class="p">(</span><span class="nf">internal-body</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">body</span><span class="p">))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">scan-out-defines</span> <span class="nv">body</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">define-vars</span> <span class="p">(</span><span class="nb">map </span><span class="nv">definition-variable</span> <span class="p">(</span><span class="nf">internal-defines</span> <span class="nv">body</span><span class="p">)))</span>
	     <span class="p">(</span><span class="nf">define-bodys</span> <span class="p">(</span><span class="nb">map </span><span class="nv">definition-value</span> <span class="p">(</span><span class="nf">internal-defines</span> <span class="nv">body</span><span class="p">)))</span>
	     <span class="p">(</span><span class="nf">inside-body</span> <span class="p">(</span><span class="nf">internal</span> <span class="nv">body</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">define-vars</span><span class="p">)</span>
	     <span class="nv">inside-body</span>
	     <span class="p">(</span><span class="nb">append </span><span class="p">(</span><span class="nf">transfer-defines-let</span> <span class="nv">define-vars</span> <span class="nv">define-bodys</span><span class="p">)</span>
		     <span class="p">(</span><span class="nf">scan-out-defines</span> <span class="nv">inside-body</span><span class="p">)))))</span>

     <span class="c1">;; c</span>

     <span class="c1">;; prefer to implement it in the make-procedure</span>
     <span class="c1">;; since most procedures defined would be utilized more than one time</span>
     <span class="c1">;; so it's more efficient</span>
     <span class="c1">;; when implement it in procedure-body</span>
     <span class="c1">;; it would transfer the body every time when call it</span>
</pre></div>
</div>
</li>

<li>
<a id="org5001c60"></a>4.17<br><div class="outline-text-5" id="text-org5001c60">
<div class="highlight"><pre><span></span>     <span class="c1">;; when the first form is utilized</span>
     <span class="c1">;; the current env is like that</span>
     <span class="c1">;; (cons (cons (list 'u 'v) (list e1 e2)) base-env)</span>


     <span class="c1">;; whe the second form is utilized</span>
     <span class="c1">;; the current env is like that</span>
     <span class="c1">;; (cons (cons (list 'u 'v) (list e1 e2)) (cons '() base-env))</span>
     <span class="c1">;; cause that let is another form of lambda</span>
     <span class="c1">;; the extend-environment is called twice</span>

     <span class="c1">;; there is no difference of behaviours between both forms</span>
     <span class="c1">;; for they're able to fetch the same desired key-value bindings</span>

     <span class="c1">;; for now I could not figure out how to solve this</span>
</pre></div>
</div>
</li>

<li>
<a id="org9f58dfc"></a>4.18<br><div class="outline-text-5" id="text-org9f58dfc">
<div class="highlight"><pre><span></span>     <span class="c1">;; the way defined in this exercise won't work</span>
     <span class="c1">;; the way defined in context will work</span>

     <span class="c1">;; just transfer the way defined in this exercise to lambda form</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">solve</span> <span class="nv">f</span> <span class="nv">y0</span> <span class="nv">dt</span><span class="p">)</span>
       <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">y</span> <span class="nv">dy</span><span class="p">)</span>
	  <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">a</span> <span class="nv">b</span><span class="p">)</span>
	     <span class="p">(</span><span class="k">set! </span><span class="nv">y</span> <span class="nv">a</span><span class="p">)</span>
	     <span class="p">(</span><span class="k">set! </span><span class="nv">dy</span> <span class="nv">b</span><span class="p">))</span>
	   <span class="p">(</span><span class="nf">integral</span> <span class="p">(</span><span class="k">delay </span><span class="nv">dy</span><span class="p">)</span> <span class="nv">y0</span> <span class="nv">dt</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">stream</span> <span class="nv">f</span> <span class="nv">y</span><span class="p">))</span>			<span class="c1">;this will fail due to the y is still '*unassigned here</span>
	  <span class="nv">y</span><span class="p">)</span>
	<span class="ss">'*unassigned*</span>
	<span class="ss">'*unassigned*</span><span class="p">))</span>
</pre></div>
</div>
</li>

<li>
<a id="org29b99bd"></a>4.19<br><div class="outline-text-5" id="text-org29b99bd">
<div class="highlight"><pre><span></span>     <span class="c1">;; ben</span>

     <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">a</span><span class="p">)</span>
	<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">define </span><span class="nv">b</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">x</span><span class="p">))</span>
	  <span class="p">(</span><span class="k">define </span><span class="nv">a</span> <span class="mi">5</span><span class="p">)</span>
	  <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
	<span class="p">(</span><span class="nf">f</span> <span class="mi">10</span><span class="p">))</span>
      <span class="mi">1</span><span class="p">)</span>

     <span class="c1">;; in this way the output is 16</span>

     <span class="c1">;; alysssa</span>

     <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">a</span><span class="p">)</span>
	<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">b</span> <span class="ss">'*unassigned*</span><span class="p">)</span>
		<span class="p">(</span><span class="nf">a</span> <span class="ss">'*unassigned*</span><span class="p">))</span>
	    <span class="p">(</span><span class="k">set! </span><span class="nv">b</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">x</span><span class="p">))</span>
	    <span class="p">(</span><span class="k">set! </span><span class="nv">a</span> <span class="mi">5</span><span class="p">)</span>
	    <span class="p">(</span><span class="nb">+ </span><span class="nv">a</span> <span class="nv">b</span><span class="p">)))</span>
	<span class="p">(</span><span class="nf">f</span> <span class="mi">10</span><span class="p">))</span>
      <span class="mi">1</span><span class="p">)</span>

     <span class="c1">;; in this way an error occurred</span>

     <span class="c1">;; in theory eva is right, but it is hard to implement</span>
     <span class="c1">;; then alysssa's idea is more reasonable than ben's</span>
     <span class="c1">;; if simultaneous internal definitions are necessary and desired</span>

     <span class="c1">;; the output of ben's way is false</span>
     <span class="c1">;; reporting an error like alysssa's way is more acceptable.</span>
     <span class="c1">;; fot that an error is always better than a false result</span>
</pre></div>
</div>
</li>

<li>
<a id="orga0f40bc"></a>4.20<br><div class="outline-text-5" id="text-orga0f40bc">
<div class="highlight"><pre><span></span>     <span class="c1">;; a</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">letrec?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'letrec</span><span class="p">))</span>

     <span class="c1">;; based on exercise 4.16</span>
     <span class="c1">;; transfer it to the let with 'unassigned &amp; set!</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">letrec-exps</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">letrec-bindings</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">letrec-body</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">var</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">expression</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">letrec-&gt;let</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">transfer</span> <span class="p">(</span><span class="nf">letrec-exps</span> <span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">transfer</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">bindings</span> <span class="p">(</span><span class="nf">letrec-bindings</span> <span class="nv">exp</span><span class="p">))</span>
	     <span class="p">(</span><span class="nf">body</span> <span class="p">(</span><span class="nf">letrec-body</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">var-list</span> <span class="p">(</span><span class="nb">map </span><span class="nv">var</span> <span class="nv">bindings</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">exp-list</span> <span class="p">(</span><span class="nb">map </span><span class="nv">expression</span> <span class="nv">bindings</span><span class="p">)))</span>
	   <span class="p">(</span><span class="nb">append </span><span class="p">(</span><span class="nb">list </span><span class="ss">'let</span> <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">var</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="nv">var</span> <span class="ss">'unassigned</span><span class="p">))</span> <span class="nv">var-list</span><span class="p">))</span>
		   <span class="p">(</span><span class="nb">append </span> <span class="p">(</span><span class="nf">map</span>
			     <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">var</span> <span class="nv">expression</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="ss">'set!</span> <span class="nv">var</span> <span class="nv">expression</span><span class="p">))</span>
			     <span class="nv">var-list</span> <span class="nv">exp-list</span><span class="p">)</span>
			    <span class="nv">body</span><span class="p">)))))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">eval-letrec</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">eval </span><span class="p">(</span><span class="nf">letrec-&gt;let</span><span class="p">)</span> <span class="nv">env</span><span class="p">))</span>

     <span class="c1">;; implement letrec? and eval-letrec in eval</span>


     <span class="c1">;; b</span>

     <span class="c1">;; The lambda in `let' is evaluated in the context of the enclosing environment, </span>
     <span class="c1">;; in which the bindings of the lambda itself are not in place. </span>
     <span class="c1">;; save the illustrations.</span>
</pre></div>
</div>
</li>

<li>
<a id="org49a4594"></a>4.21<br><div class="outline-text-5" id="text-org49a4594">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
       <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">fact</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">fact</span> <span class="nv">fact</span> <span class="nv">n</span><span class="p">))</span>
	<span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">ft</span> <span class="nv">k</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">k</span> <span class="mi">1</span><span class="p">)</span>
	      <span class="mi">1</span>
	      <span class="p">(</span><span class="nb">* </span><span class="nv">k</span> <span class="p">(</span><span class="nf">ft</span> <span class="nv">ft</span> <span class="p">(</span><span class="nb">- </span><span class="nv">k</span> <span class="mi">1</span><span class="p">))))))</span>
       <span class="mi">10</span><span class="p">)</span>

     <span class="c1">;; a</span>

     <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
	<span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nf">fib</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">fib</span> <span class="nv">fib</span> <span class="nv">n</span><span class="p">))</span>
	 <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">fb</span> <span class="nv">k</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">= </span><span class="nv">k</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
		 <span class="p">((</span><span class="nb">= </span><span class="nv">k</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
		 <span class="p">(</span><span class="nf">else</span>
		  <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">fb</span> <span class="nv">fb</span> <span class="p">(</span><span class="nb">- </span><span class="nv">k</span> <span class="mi">1</span><span class="p">))</span>
		     <span class="p">(</span><span class="nf">fb</span> <span class="nv">fb</span> <span class="p">(</span><span class="nb">- </span><span class="nv">k</span> <span class="mi">2</span><span class="p">))))))))</span>
      <span class="mi">3</span><span class="p">)</span>

     <span class="c1">;; b</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span>
       <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nb">even? </span><span class="nv">n</span><span class="p">)</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">=n</span> <span class="mi">0</span><span class="p">)</span>
	     <span class="nv">true</span>
	     <span class="p">(</span><span class="nb">odd? </span><span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))</span>
       <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nb">odd? </span><span class="nv">n</span><span class="p">)</span>
	 <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span>
	     <span class="nv">false</span>
	     <span class="p">(</span><span class="nb">even? </span><span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))</span>
       <span class="p">(</span><span class="nb">even? </span><span class="nv">x</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">f</span> <span class="nv">x</span><span class="p">)</span>
       <span class="p">((</span><span class="k">lambda </span><span class="p">(</span><span class="nb">even? </span><span class="nv">odd?</span><span class="p">)</span>
	  <span class="p">(</span><span class="nb">even? </span><span class="nv">even?</span> <span class="nv">odd?</span> <span class="nv">x</span><span class="p">))</span>
	<span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">ev?</span> <span class="nv">od?</span> <span class="nv">n</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">true</span> <span class="p">(</span><span class="nf">od?</span> <span class="nv">ev?</span> <span class="nv">od?</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))</span>
	<span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">ev?</span> <span class="nv">od?</span> <span class="nv">n</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="nv">n</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">false</span> <span class="p">(</span><span class="nf">ev?</span> <span class="nv">ev?</span> <span class="nv">od?</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">))))))</span>
</pre></div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orge7e1b5e" class="outline-4">
<h4 id="orge7e1b5e">将语法分析与执行分离</h4>
<div class="outline-text-4" id="text-orge7e1b5e">
<ol class="org-ol">
<li>前面实现的求值器确实很简单，但却也非常低效，因为有关表达式的语法分析与它
们的执行交织在一起，如果一个程序要执行许多次，对于它的语法分析也就需要做
许多次，可以对这个求值器做一些变换，使它的效率大大提高，采用的方法就是重
新安排其中的工作，使有关的语法分析只进行一次；</li>
</ol>
</div>
</div>

<div id="outline-container-orgc552038" class="outline-4">
<h4 id="orgc552038">练习 4.22-4.24</h4>
<div class="outline-text-4" id="text-orgc552038">
</div>
<ul class="org-ul">
<li>
<a id="org782fc7f"></a>4.22<br><div class="outline-text-5" id="text-org782fc7f">
<div class="highlight"><pre><span></span>     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let?</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'let</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-exps</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cdr </span><span class="nv">exp</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">var</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">car </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">expression</span> <span class="nv">binding</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">cadr </span><span class="nv">binding</span><span class="p">))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">let-&gt;application</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">transfer</span> <span class="p">(</span><span class="nf">let-exps</span> <span class="nv">exp</span><span class="p">)))</span>

     <span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">analyze-let</span> <span class="nv">exp</span><span class="p">)</span>
       <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">bindings</span> <span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">))</span>
	     <span class="p">(</span><span class="nf">body</span> <span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">)))</span>
	 <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">var-list</span> <span class="p">(</span><span class="nb">map </span><span class="nv">var</span> <span class="nv">bindings</span><span class="p">))</span>
	       <span class="p">(</span><span class="nf">exp-list</span> <span class="p">(</span><span class="nb">map </span><span class="nv">expression</span> <span class="nv">bindings</span><span class="p">)))</span>
	   <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">proc</span> <span class="p">(</span><span class="nf">make-lambda</span> <span class="nv">var-list</span> <span class="nv">body</span><span class="p">)))</span>
	     <span class="p">(</span><span class="nf">analyze-application</span>
	      <span class="p">(</span><span class="nb">cons </span><span class="nv">proc</span> <span class="nv">exp-list</span><span class="p">))))))</span>
</pre></div>
</div>
</li>

<li>
<a id="orgf112455"></a>4.23<br><div class="outline-text-5" id="text-orgf112455">
<div class="highlight"><pre><span></span>     <span class="c1">;; the version in text unrolls all the procs of the sequence exps by utilizing procedure sequentially</span>

     <span class="c1">;; while the version defined by Alyssa unrolls the procs in runtime, not in the analyze time</span>
     <span class="c1">;; due to the recursive pattern of procedure execute-sequence and the return lambda result of analyze-sequence</span>
     <span class="c1">;; it would unroll the procs everytime when we apply the analyzed result</span>
</pre></div>
</div>
</li>

<li>
<a id="org7636a8c"></a>4.24<br><div class="outline-text-5" id="text-org7636a8c">
<div class="highlight"><pre><span></span>     <span class="c1">;; 显然本节所给出的版本效率更高；</span>
     <span class="c1">;; 评估就不做了。</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
            
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="https-zero4drift-github-io",
            disqus_url="https://zero4drift.github.io/posts/sicp-refresher-chapter-4%281%29/",
        disqus_title="SICP-Refresher-Chapter-4(1)",
        disqus_identifier="cache/posts/sicp-refresher-chapter-4(1).html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        
    


        </div>
    </div>

    
    <footer><div class="container">
            <div class="social">



                <div class="social-entry">
                    <a href="../../rss.xml" target="_blank">
                        <i class="fa fa-rss"></i> 
                    </a>
                </div>
            </div>
                <div class="copyright">
                    Contents © 2019         <a href="mailto:fang0052@e.ntu.edu.sg">zero4drift</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
                    
                </div>
           
        </div>
    </footer><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?06e0ade16d98033ac1aad78106d873c8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script src="../../assets/js/all-nocdn.js" type="text/javascript"></script>
</body>
</html>
