<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>CSAPP-proxylab 解题思路记录 - 找一个吃麦旋风的理由</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="zero4drift" />
  <meta name="description" content="准备 proxy lab 的难度和 malloc lab 不在一个数量级上，主要体现在两个方面： 除了第三部分要实现 cache 以外，前面两部分要求实现 proxy 和 synchronization, 都可以在书上的示例代码中拼凑出来" />

  <meta name="keywords" content="代码, 算法, 工具" />






<meta name="generator" content="Hugo 0.48" />


<link rel="canonical" href="https://zero4drift.github.io/post/csapp-proxylab-jie-ti-si-lu-ji-lu/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.28854364c052ec02eba4ee5867bc889d3a567cdf337ba3a355c33511d20bee1e.css" integrity="sha256-KIVDZMBS7ALrpO5YZ7yInTpWfN8ze6OjVcM1EdIL7h4=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="CSAPP-proxylab 解题思路记录" />
<meta property="og:description" content="准备 proxy lab 的难度和 malloc lab 不在一个数量级上，主要体现在两个方面： 除了第三部分要实现 cache 以外，前面两部分要求实现 proxy 和 synchronization, 都可以在书上的示例代码中拼凑出来" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zero4drift.github.io/post/csapp-proxylab-jie-ti-si-lu-ji-lu/" /><meta property="article:published_time" content="2018-03-25T19:48:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-01-14T22:23:33&#43;08:00"/>
<meta itemprop="name" content="CSAPP-proxylab 解题思路记录">
<meta itemprop="description" content="准备 proxy lab 的难度和 malloc lab 不在一个数量级上，主要体现在两个方面： 除了第三部分要实现 cache 以外，前面两部分要求实现 proxy 和 synchronization, 都可以在书上的示例代码中拼凑出来">


<meta itemprop="datePublished" content="2018-03-25T19:48:00&#43;08:00" />
<meta itemprop="dateModified" content="2018-03-25T19:48:00&#43;08:00" />
<meta itemprop="wordCount" content="3152">



<meta itemprop="keywords" content="csapp-lab,c," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CSAPP-proxylab 解题思路记录"/>
<meta name="twitter:description" content="准备 proxy lab 的难度和 malloc lab 不在一个数量级上，主要体现在两个方面： 除了第三部分要实现 cache 以外，前面两部分要求实现 proxy 和 synchronization, 都可以在书上的示例代码中拼凑出来"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112733609-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">找一个吃麦旋风的理由</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/post/">存档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/categories/">分类</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      找一个吃麦旋风的理由
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/post/">存档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://zero4drift.github.io/categories/">分类</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">CSAPP-proxylab 解题思路记录</h1>
      
      <div class="post-meta">
        <time datetime="2018-03-25" class="post-time">
          2018-03-25
        </time>
        <div class="post-category">
            <a href="https://zero4drift.github.io/categories/csapp/"> CSAPP </a>
            
          </div>
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#准备">准备</a></li>
<li><a href="#代码">代码</a>
<ul>
<li><a href="#proxy">proxy</a></li>
<li><a href="#synchronization">synchronization</a></li>
<li><a href="#cache">cache</a></li>
</ul></li>
<li><a href="#写在后面">写在后面</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h2 id="准备">准备</h2>

<p>proxy lab 的难度和 malloc lab 不在一个数量级上，主要体现在两个方面：</p>

<ol>
<li>除了第三部分要实现 cache 以外，前面两部分要求实现 proxy 和
synchronization, 都可以在书上的示例代码中拼凑出来；</li>
<li>测试评分宽松，通过就满分，malloc lab 可是按性能评分的；</li>
</ol>

<p>简单归简单，但是不能不做准备工作：</p>

<ol>
<li>仔细看一遍 proxy lab 的说明文档，在 csapp3e labs 官网上；</li>
<li>熟读 csapp3e 第11章，略读第10章，第12章；</li>
</ol>

<p>要求实现三个功能：</p>

<ol>
<li><a href="#proxy">proxy</a></li>
<li><a href="#synchronization">synchronization</a></li>
<li><a href="#cache">cache</a></li>
</ol>

<h2 id="代码">代码</h2>

<h3 id="proxy">proxy</h3>

<p>这部分的代码大半都可以复用 tiny.c 的代码，包括函数 <code>read_requesthdrs</code>,
<code>clienterror</code>, <code>doit</code> 的大部分， <code>main</code> 的大部分。</p>

<p>定义几个字符串全局变量做为请求的头部分：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user_agent_hdr</span> <span class="o">=</span> <span class="s">&#34;user-agent: mozilla/5.0 (x11; linux x86_64; rv:52.0) gecko/20100101 firefox/52.0</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">accept_hdr</span> <span class="o">=</span> <span class="s">&#34;accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">accept_encoding_hdr</span> <span class="o">=</span> <span class="s">&#34;accept-encoding: gzip, deflate</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">language_hdr</span> <span class="o">=</span> <span class="s">&#34;accept-language: zh,en-us;q=0.7,en;q=0.3</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">connection_hdr</span> <span class="o">=</span> <span class="s">&#34;connection: close</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pxy_connection_hdr</span> <span class="o">=</span> <span class="s">&#34;proxy-connection: close</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">secure_hdr</span> <span class="o">=</span> <span class="s">&#34;upgrade-insecure-requests: 1</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>别忘了 lab 说明文档中要求在 proxy 的运行过程中遇到 <code>sigpipe</code> 信号时不要报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* handle sigpipe signal */</span>
<span class="kt">void</span> <span class="nf">sigpipe_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;sigpipe handled %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>以及负责解析 client 发送的网址请求（原谅我，就像注释中说的，这个函数我没有自己写，
只是稍微改了一下，被 malloc lab 折腾惨了，抠细节的代码不想再写了）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * this parse function i just copy the idea from another genius
</span><span class="cm"> * do not want to spend too much time in that helper function
</span><span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">parse_uri</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">scheme</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">ptr</span> <span class="o">=</span> <span class="n">uri</span><span class="p">;</span>

  <span class="n">tmp</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">null</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">len</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">strncpy</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">scheme</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">scheme</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">scheme</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="s">&#34;http&#34;</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
  <span class="n">ptr</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="sc">&#39;/&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">ptr</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">tmp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="sc">&#39;\0&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="sc">&#39;:&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">||</span> <span class="sc">&#39;/&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">tmp</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">len</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">strncpy</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">host</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

  <span class="n">ptr</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="sc">&#39;:&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="cm">/* read port */</span>
    <span class="k">while</span> <span class="p">(</span><span class="sc">&#39;\0&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="sc">&#39;/&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">)</span>
      <span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">strncpy</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">port</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">port</span> <span class="o">=</span> <span class="s">&#34;80&#34;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="sc">&#39;\0&#39;</span> <span class="o">==</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">tmp</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="sc">&#39;\0&#39;</span> <span class="o">!=</span> <span class="o">*</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
  <span class="n">len</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">strncpy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">path</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p><code>main</code> 函数的前半部分和 tiny.c 的一致，在检查命令行参数是否合法之后：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">Signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">sigpipe_handler</span><span class="p">);</span>

<span class="n">listenfd</span> <span class="o">=</span> <span class="n">Open_listenfd</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">clientlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clientaddr</span><span class="p">);</span>
  <span class="n">connfd</span> <span class="o">=</span> <span class="n">Accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clientaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clientlen</span><span class="p">);</span>
  <span class="n">Getnameinfo</span><span class="p">((</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">clientaddr</span><span class="p">,</span> <span class="n">clientlen</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span>
	      <span class="n">port</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Accepted connection from (%s, %s)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
  <span class="n">do_it</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
  <span class="n">Close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
 <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>然后就是 <code>do_it</code> 函数，它负责 proxy 的主要功能：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">doit</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">up_buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">method</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">uri</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">host</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">cache</span><span class="p">[</span><span class="n">MAX_OBJECT_SIZE</span><span class="p">];</span>
  <span class="n">rio_t</span> <span class="n">rio</span><span class="p">,</span> <span class="n">sio</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">up_fd</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Read request line and headers */</span>
  <span class="n">Rio_readinitb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Rio_readlineb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;%s %s %s&#34;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s">&#34;GET&#34;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">clienterror</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="s">&#34;501&#34;</span><span class="p">,</span> <span class="s">&#34;Not Implemented&#34;</span><span class="p">,</span>
		  <span class="s">&#34;Proxy does not implement this method&#34;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">read_requesthdrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rio</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">clienterror</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="s">&#34;404&#34;</span><span class="p">,</span> <span class="s">&#34;Not found&#34;</span><span class="p">,</span> <span class="s">&#34;Request could not be parsed&#34;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">up_fd</span> <span class="o">=</span> <span class="n">Open_clientfd</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
  <span class="n">Rio_readinitb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sio</span><span class="p">,</span> <span class="n">up_fd</span><span class="p">);</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="n">up_buf</span><span class="p">,</span> <span class="s">&#34;GET %s HTTP/1.0</span><span class="se">\r\n</span><span class="s">Host: %s</span><span class="se">\r\n</span><span class="s">%s%s%s%s%s%s%s</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">user_agent_hdr</span><span class="p">,</span> <span class="n">accept_hdr</span><span class="p">,</span> <span class="n">language_hdr</span><span class="p">,</span> <span class="n">accept_encoding_hdr</span><span class="p">,</span> <span class="n">connection_hdr</span><span class="p">,</span> <span class="n">secure_hdr</span><span class="p">,</span> <span class="n">pxy_connection_hdr</span><span class="p">);</span>
  <span class="n">Rio_writen</span><span class="p">(</span><span class="n">up_fd</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">up_buf</span><span class="p">));</span>

  <span class="k">while</span><span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">Rio_readlineb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sio</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">content_type_ignore</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
      <span class="n">m</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
      <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这样就可以实现一个简单的单线程 proxy 功能。</p>

<h3 id="synchronization">synchronization</h3>

<p>大部份相关代码都可以借鉴 CSAPP3e 第12章的关于并发编程的例子（Pthread）：</p>

<p>一个 thread 包装函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="o">*</span><span class="nf">thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">var</span><span class="p">);</span>
  <span class="n">Pthread_detach</span><span class="p">(</span><span class="n">Pthread_self</span><span class="p">());</span>
  <span class="n">Signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">sigpipe_handler</span><span class="p">);</span>
  <span class="n">doit</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="n">Close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在 <code>main</code> 函数中修改原来调用 <code>do_it</code> 的那部分代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">Pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connfd</span><span class="p">);</span>
<span class="cm">/* 因为在 thread 包装器中已经写了 Close(fd), main 函数中就可以省去了 */</span></code></pre></td></tr></table>
</div>
</div>
<p>如果前面 proxy 功能能通过测试的话，这个多线程就可以正常工作。</p>

<h3 id="cache">cache</h3>

<p>这里实现的是一个双向链表来存储缓存内容（感谢 malloc lab 给的灵感），就像前面所说
的，proxy lab 测试要求比较低，并没有很复杂的边界条件，通过测试是没有问题的，但是
这个双向链表实现出来以后有些地方不能和说明文档里的要求（可能只时建议）保持一致：</p>

<ol>
<li><p>由于缓存替换要求实现 LRU 算法（或者接近 LRU），作者在这里是严格按照 LRU 算法
来做的，具体是：</p>

<ol>
<li>每次读写都算做一次使用该链表元素</li>
<li>讲新近读写的缓存从链表中挑出，将它的前后链表关系置为 <code>NULL</code></li>
<li>链接它的前后元素</li>
<li>插入链表头</li>
</ol></li>

<li><p>但是问题就来了，因为这是一个支持多线程的 proxy, 这些线程共用一个链表（当然了），
所以每次更新链表的操作就需要加 <strong>锁</strong>, 每次读写都需要；虽然我在读缓存的代码中加
入了一个条件判断语句：如果链表头就是当前缓存元素，就跳过链表更新；毕竟如果有
多个线程同时读一个缓存的话，第一个加锁并读完的的线程将会把它置于链接头并释放
锁，后面等待的线程就可以跳过更新链表操作从而实现说明文档上的读并行；但是如果
有特别复杂的线程并行情况，比如最坏的情况：大量并行线程读取两个不同的缓存，链
表头更迭频繁，读并行就无法实现了。</p></li>

<li><p>大量的链表链接关系更新，多线程导致每处链表关系更新和读取都需要加锁；也考虑过
用单向链表和缓存内加时间戳来实现 LRU 算法，但是，单向链表的添加和解除元素在多
线程的情况下还是得加锁，并没有很大得并发提升。</p></li>

<li><p>写缓存在说明文档中是明确要求加锁（或者生产者消费者并发模形），在缓存结构体中
添加一个 <code>mutex</code> 来实现，每次要写缓存都要添加锁和释放锁。</p></li>

<li><p>使用固定大小的数组来取代链表？在多线程情况下从数组中存取元素照样得上锁；</p></li>

<li><p>综上这些问题都是选用链表而引出来，单向或者双向都无法避免，应该还会有对并发更
友好数据模形，实在不想折腾了（在经过 malloc lab 得折腾之后作者已经懈怠了），
等以后知识量上去了，或者真的有灵光一闪，再来处理这个。</p></li>

<li><p>#<a id="org463ab8d"></a>：<span class="timestamp-wrapper"><span class="timestamp">&lt;2018-04-06 Fri&gt; </span></span> 看了下 CSAPP3e 12.5.14 P707 读者优先的读者－写者模形，
一部分实现读者优先的代码可以借用到 cache.c 的读缓存函数里，可以实现读缓存的并
行实现（不过极端条件下当并行读取的进程同时进入 <code>if(!(cache_node =</code>
CACHE_HEAD))== 时，就几乎没有并行可言了）；书中的读者－写者模形整体来看并不适合
做 proxylab 要求的缓存：书中的模形过于简单，基于生产者－消费者模形的－有东西
产出就取走，而缓存要求的是有匹配的内容就读取该内容，无匹配就将获得的数据做为
缓存插入，不过 <code>sbuf</code> 这个数据结构还是可以借用的，需要大改，改造思路就是 LRU
链表替换原来的数组，或者保理数组，新加入一个数据结构存储每一个缓存的地址并桉
照 LRU 顺序排列；</p></li>
</ol>

<p>缓存结构体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">cache</span><span class="p">{</span>
  <span class="kt">int</span> <span class="n">conn</span><span class="p">;</span>			        <span class="cm">/* is it a buf while connection */</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAX_OBJECT_SIZE</span><span class="p">];</span>            <span class="cm">/* buf */</span>
  <span class="kt">char</span> <span class="n">uri</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>		        <span class="cm">/* buf&#39;s uri */</span>
  <span class="n">sem_t</span> <span class="n">mutex</span><span class="p">;</span>				<span class="cm">/* sem_t mutex */</span>
  <span class="k">struct</span> <span class="n">cache</span> <span class="o">*</span><span class="n">next_cache</span><span class="p">;</span>	        <span class="cm">/* next cache */</span>
  <span class="k">struct</span> <span class="n">cache</span> <span class="o">*</span><span class="n">prev_cache</span><span class="p">;</span>		<span class="cm">/* previous cache */</span>
<span class="p">}</span><span class="n">cache</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p>配套方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* initial CACHE_HEAD and sem_t mutex for the whole linked list */</span>
<span class="kt">void</span> <span class="nf">init_cache_list</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">CACHE_HEAD</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">Sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* insert cachenode as the head */</span>
<span class="kt">void</span> <span class="nf">insert_cache_head</span><span class="p">(</span><span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">CACHE_HEAD</span> <span class="o">==</span> <span class="n">cache_node</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">CACHE_HEAD</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">CACHE_HEAD</span><span class="o">-&gt;</span><span class="n">prev_cache</span> <span class="o">=</span> <span class="n">cache_node</span><span class="p">;</span>
      <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">next_cache</span> <span class="o">=</span> <span class="n">CACHE_HEAD</span><span class="p">;</span>
      <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">prev_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">CACHE_HEAD</span> <span class="o">=</span> <span class="n">cache_node</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">else</span> <span class="n">CACHE_HEAD</span> <span class="o">=</span> <span class="n">cache_node</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* break the node relations of a cache_node, and link the prev and next */</span>
<span class="kt">void</span> <span class="nf">repair_cache_link</span><span class="p">(</span><span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">cache_node</span> <span class="o">==</span> <span class="n">CACHE_HEAD</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">prev</span> <span class="o">=</span> <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">prev_cache</span><span class="p">;</span>
      <span class="n">next</span> <span class="o">=</span> <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">next_cache</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next_cache</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">prev_cache</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
      <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">prev_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">next_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* write cache */</span>
<span class="n">cache</span> <span class="o">*</span><span class="nf">write_cache</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span> <span class="o">=</span> <span class="n">find_cache</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cache_node</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">cache_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">cache</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cache</span><span class="p">));</span>
      <span class="n">Sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
  <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* write as connection */</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">,</span> <span class="n">uri</span><span class="p">);</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cache_node</span> <span class="o">==</span> <span class="n">CACHE_HEAD</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">repair_cache_link</span><span class="p">(</span><span class="n">cache_node</span><span class="p">);</span>
      <span class="n">insert_cache_head</span><span class="p">(</span><span class="n">cache_node</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">cache_node</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* after lost connection, turn off flag conn, handle eviction */</span>
<span class="kt">void</span> <span class="nf">hadnle_after_disconn</span><span class="p">(</span><span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
  <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">conn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
  <span class="n">size</span> <span class="o">=</span> <span class="n">get_whole_cache_size</span><span class="p">();</span>
  <span class="k">while</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_CACHE_SIZE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">);</span>
      <span class="n">delete_tail_cache</span><span class="p">();</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">get_whole_cache_size</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read cache */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">read_cache</span><span class="p">(</span><span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnt_lock</span><span class="p">);</span>
  <span class="n">readcnt</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">readcnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnt_lock</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cache_node</span> <span class="o">==</span> <span class="n">CACHE_HEAD</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
      <span class="n">repair_cache_link</span><span class="p">(</span><span class="n">cache_node</span><span class="p">);</span>
      <span class="n">insert_cache_head</span><span class="p">(</span><span class="n">cache_node</span><span class="p">);</span>
      <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">buf</span> <span class="o">=</span> <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

  <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnt_lock</span><span class="p">);</span>
  <span class="n">readcnt</span><span class="o">--</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">readcnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
  <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cnt_lock</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* find cache based on host and path, if not exists, return NULL */</span>
<span class="n">cache</span> <span class="o">*</span><span class="nf">find_cache</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span> <span class="o">=</span> <span class="n">CACHE_HEAD</span><span class="p">;</span>
  <span class="k">while</span><span class="p">(</span><span class="n">cache_node</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;2&#34;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>
	<span class="k">return</span> <span class="n">cache_node</span><span class="p">;</span>
      <span class="k">else</span> <span class="n">cache_node</span> <span class="o">=</span> <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">next_cache</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cache size, not the whole cache size but the buf size */</span>
<span class="n">size_t</span> <span class="nf">get_cache_size</span><span class="p">(</span><span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* the size of entire cache list, only the buf size included */</span>
<span class="n">size_t</span> <span class="nf">get_whole_cache_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span> <span class="o">=</span> <span class="n">CACHE_HEAD</span><span class="p">;</span>
  <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="n">cache_node</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;3&#34;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="n">size</span> <span class="o">+=</span> <span class="n">get_cache_size</span><span class="p">(</span><span class="n">cache_node</span><span class="p">);</span>
      <span class="n">cache_node</span> <span class="o">=</span> <span class="n">cache_node</span><span class="o">-&gt;</span><span class="n">next_cache</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* find tail cache */</span>
<span class="n">cache</span> <span class="o">*</span><span class="nf">find_tail_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">temp_cache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">tail_cache</span> <span class="o">=</span> <span class="n">CACHE_HEAD</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="n">tail_cache</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;4&#34;</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tail_cache</span><span class="o">-&gt;</span><span class="n">next_cache</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tail_cache</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="k">return</span> <span class="n">tail_cache</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">tail_cache</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="n">temp_cache</span> <span class="o">=</span> <span class="n">tail_cache</span><span class="p">;</span>
      <span class="n">tail_cache</span> <span class="o">=</span> <span class="n">tail_cache</span><span class="o">-&gt;</span><span class="n">next_cache</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">temp_cache</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* delete a tail cache_node */</span>
<span class="kt">void</span> <span class="nf">delete_tail_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">cache</span> <span class="o">*</span><span class="n">tail_cache</span> <span class="o">=</span> <span class="n">find_tail_cache</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="n">tail_cache</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">P</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
      <span class="n">repair_cache_link</span><span class="p">(</span><span class="n">tail_cache</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">tail_cache</span><span class="p">);</span>
      <span class="n">V</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在 proxy.c 中实现缓存，在 <code>main</code> 函数中初始化链表：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">init_cache_list</span><span class="p">();</span></code></pre></td></tr></table>
</div>
</div>
<p>检查 client 提交的 uri 有没有缓存，如果没有缓存，按原来的逻辑执行下去并缓存收到的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="n">cache</span><span class="p">[</span><span class="n">MAX_OBJECT_SIZE</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">content_type_ignore</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">cache</span> <span class="o">*</span><span class="n">cache_node</span><span class="p">;</span>

<span class="cm">/* 省略 */</span>

<span class="cm">/* if already cached */</span>
<span class="n">cache_node</span> <span class="o">=</span> <span class="n">find_cache</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">cache_node</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">up_buf</span><span class="p">,</span> <span class="n">read_cache</span><span class="p">(</span><span class="n">cache_node</span><span class="p">));</span>
    <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">up_buf</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

<span class="cm">/* if not cached */</span>

<span class="cm">/* 省略 */</span>

<span class="k">while</span><span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">Rio_readlineb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sio</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">content_type_ignore</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
    <span class="n">m</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">Rio_writen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">content_type_ignore</span><span class="p">)</span> <span class="n">strcat</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">up_buf</span><span class="p">);</span>
  <span class="p">}</span>
<span class="k">if</span><span class="p">(</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">MAX_OBJECT_SIZE</span><span class="p">)</span> <span class="n">cache_node</span> <span class="o">=</span> <span class="n">write_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">uri</span><span class="p">);</span>
<span class="cm">/* ready to disconnect */</span>
<span class="n">hadnle_after_disconn</span><span class="p">(</span><span class="n">cache_node</span><span class="p">);</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="写在后面">写在后面</h2>

<p>proxy lab 这样结束掉虽然能通过测试，它现在内部的代码逻辑还是存在很多问题的；</p>

<p>这次作者选择划水；</p>

<p>一来这次的 lab 过于功能性，网络编程和并发编程的知识结构比较顶层，做了收获有限，
投入大量时间并不值得；</p>

<p>二来作者当前的知识量也不够（数据结构、算法、一些顶层实现的函数接口），深挖下去效
率太低，这些时间可以花在更重要的事情上。</p>

<p>就这样吧，这里的代码以后会有重构的那一天的。</p>

<p><span class="timestamp-wrapper"><span class="timestamp">&lt;2018-04-06 Fri&gt; </span></span> <a href="#org463ab8d">7</a> 稍微改进了读缓存的并行性 。</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">zero4drift</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-01-14</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://zero4drift.github.io/tags/csapp-lab/">csapp-lab</a>
          <a href="https://zero4drift.github.io/tags/c/">c</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/cpp-primer-5th-exercises-chapter-1/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Cpp-Primer-5th-Exercises-Chapter-1</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/csapp-malloclab-jie-ti-si-lu-ji-lu/">
            <span class="next-text nav-default">CSAPP-malloclab 解题思路记录</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "zero4drift/comments-for-my-blog"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
  
    <a href="fang0052@e.ntu.edu.sg" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/zero4drift" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://zero4drift.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2018 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        zero4drift
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>

  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>










</body>
</html>
